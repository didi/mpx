<template>
  <scroll-view class="container" scroll-y="{{ true }}" testID="textPage">
    <view class="header">
      <view class="header-content">
        <view class="back-btn" bindtap="goBack" testID="backBtn">
          <text class="back-text">←</text>
        </view>
        <text class="title" testID="textTitle">Text 组件能力测试</text>
      </view>
    </view>

    <view class="config-section">
      <!-- 测试能力选择 -->
      <view class="config-item">
        <text class="config-label">测试能力</text>
        <view class="config-options">
          <view wx:for="{{ testTypes }}" wx:key="value"
            class="option-btn {{ testType === item.value ? 'btn-active' : '' }}"
            bindtap="setTestType"
            data-type="{{ item.value }}"
            testID="testType-{{item.value}}">
            {{ item.label }}
          </view>
        </view>
      </view>

      <!-- Text 数量选择 -->
      <view class="config-item">
        <text class="config-label">Text 数量</text>
        <view class="config-options">
          <view wx:for="{{ countList }}" wx:key="*this"
            class="option-btn {{ count === item ? 'btn-active' : '' }}"
            bindtap="setCount"
            data-count="{{ item }}"
            testID="count-{{item}}">
            {{ item }}
          </view>
        </view>
      </view>
    </view>

    <view class="lifecycle-info" testID="lifecycleInfo">
      <text class="info-title">生命周期耗时</text>
      <view class="info-row">
        <text class="info-label">测试能力:</text>
        <text class="info-value" testID="currentTestType">{{ currentTypeLabel }}</text>
      </view>
      <view class="info-row">
        <text class="info-label">Text 数量:</text>
        <text class="info-value" testID="currentCount">{{ count }}</text>
      </view>
      <view class="info-row-highlight">
        <text class="info-label">Created → Mounted:</text>
        <text class="info-value highlight-value" testID="duration">{{ duration }}ms</text>
      </view>
    </view>

    <view class="action-section">
      <view class="btn primary" bindtap="runTest" testID="runTestBtn">
        <text class="btn-text">{{ testing ? '测试中...' : '开始测试' }}</text>
      </view>
    </view>

    <!-- 通过 wx:if 控制子组件，每次切换都会触发完整生命周期 -->
    <view class="test-area" testID="testArea">
      <text class="area-title" testID="areaTitle">{{ currentTypeLabel }} - {{ count }} 个 Text</text>
      <text-list 
        wx:if="{{showComponent}}" 
        count="{{count}}"
        test-type="{{testType}}"
        bindready="onComponentReady"
        testID="textList"
      />
      <view class="empty-hint" wx:else testID="emptyHint">
        <text class="hint-text">点击「开始测试」渲染组件</text>
      </view>
    </view>
  </scroll-view>
</template>

<script setup>
import mpx, { ref, computed, onMounted } from '@mpxjs/core'

// 测试类型配置
const testTypes = ref([
  { label: 'Basic', value: 'basic' },
  { label: 'Simple', value: 'simple-text' },
  { label: 'Font Size', value: 'font-size' },
  { label: 'Var', value: 'var' },
  { label: 'Calc', value: 'calc' },
  { label: 'Bindtap', value: 'bindtap' },
  { label: 'Line Height', value: 'line-height' },
  { label: '综合', value: 'mixed' }
])

const testType = ref('basic')
const count = ref(100)
const testing = ref(false)
const showComponent = ref(false)
const duration = ref('0')
const countList = ref([10, 50, 100, 500, 1000])

// 当前选中类型的标签
const currentTypeLabel = computed(() => {
  const type = testTypes.value.find(t => t.value === testType.value)
  return type ? type.label : ''
})

function setTestType(e) {
  const type = e.currentTarget.dataset.type
  testType.value = type
  // 切换类型后隐藏组件，等待下次测试
  showComponent.value = false
  duration.value = '0'
}

function setCount(e) {
  const newCount = parseInt(e.currentTarget.dataset.count)
  count.value = newCount
  // 切换数量后隐藏组件，等待下次测试
  showComponent.value = false
  duration.value = '0'
}

function runTest() {
  if (testing.value) return
  
  testing.value = true
  
  // 先隐藏组件（销毁）
  showComponent.value = false
  
  // 等待销毁完成后再显示（重新创建）
  setTimeout(() => {
    showComponent.value = true
  }, 100)
}

function onComponentReady(e) {
  const detail = e.detail
  duration.value = detail.duration
  testing.value = false
  
  console.log(`[Parent] ${detail.testType} - ${detail.count} texts: ${detail.duration}ms`)
}

function goBack() {
  mpx.navigateBack()
}

// 页面加载后自动运行一次测试
onMounted(() => {
  setTimeout(() => {
    runTest()
  }, 300)
})

defineExpose({
  testTypes,
  testType,
  count,
  testing,
  showComponent,
  duration,
  countList,
  currentTypeLabel,
  setTestType,
  setCount,
  runTest,
  onComponentReady,
  goBack
})
</script>

<style>
.container {
  flex: 1;
  background-color: #f5f5f5;
}

.header {
  padding: 16px 20px;
  background: linear-gradient(135deg, #FF6B6B, #FF8E53);
}

.header-content {
  flex-direction: row;
  align-items: center;
}

.back-btn {
  width: 32px;
  height: 32px;
  align-items: center;
  justify-content: center;
  margin-right: 8px;
}

.back-text {
  font-size: 20px;
  color: #fff;
  font-weight: bold;
}

.title {
  font-size: 18px;
  font-weight: bold;
  color: #fff;
  flex: 1;
}

.config-section {
  padding: 16px;
  background-color: #fff;
  margin: 16px;
  border-radius: 12px;
}

.config-item {
  margin-bottom: 16px;
}

.config-label {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.config-options {
  flex-direction: row;
  flex-wrap: wrap;
}

.option-btn {
  padding: 8px 12px;
  background-color: #f0f0f0;
  border-radius: 6px;
  margin-right: 8px;
  margin-bottom: 8px;
  font-size: 13px;
  color: #333;
}

.btn-active {
  background-color: #FF6B6B;
  color: #fff;
}

.lifecycle-info {
  padding: 16px;
  background-color: #fff;
  margin: 0 16px 16px;
  border-radius: 12px;
}

.info-title {
  font-size: 16px;
  font-weight: bold;
  color: #333;
  margin-bottom: 12px;
}

.info-row {
  flex-direction: row;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom-width: 1px;
  border-bottom-color: #eee;
}

.info-row-highlight {
  flex-direction: row;
  justify-content: space-between;
  padding: 10px 0;
  padding-top: 12px;
  margin-top: 4px;
}

.info-label {
  font-size: 14px;
  color: #666;
}

.info-value {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.highlight-value {
  font-size: 18px;
  color: #FF6B6B;
  font-weight: bold;
}

.action-section {
  padding: 0 16px;
  margin-bottom: 16px;
}

.btn {
  padding: 14px;
  border-radius: 8px;
  align-items: center;
}

.primary {
  background-color: #FF6B6B;
}

.btn-text {
  font-size: 16px;
  color: #fff;
  font-weight: bold;
}

.test-area {
  padding: 16px;
  background-color: #fff;
  margin: 0 16px 16px;
  border-radius: 12px;
}

.area-title {
  font-size: 14px;
  color: #666;
  margin-bottom: 12px;
}

.empty-hint {
  padding: 40px 20px;
  align-items: center;
}

.hint-text {
  font-size: 14px;
  color: #999;
}
</style>

<script type="application/json">
{
  "usingComponents": {
    "text-list": "../components/text-list/index"
  },
  "navigationBarTitleText": "Text 组件能力测试"
}
</script>

