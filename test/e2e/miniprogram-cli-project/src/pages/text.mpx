<template>
  <scroll-view class="container" scroll-y="{{ true }}" testID="textPage">
    <view class="header">
      <view class="header-content">
        <view class="back-btn" bindtap="goBack" testID="backBtn">
          <text class="back-text">â†</text>
        </view>
        <text class="title" testID="textTitle">Text ç»„ä»¶èƒ½åŠ›æµ‹è¯•</text>
      </view>
    </view>

    <view class="config-section">
      <!-- æµ‹è¯•èƒ½åŠ›é€‰æ‹© -->
      <view class="config-item">
        <text class="config-label">æµ‹è¯•èƒ½åŠ›</text>
        <view class="config-options">
          <view
            wx:for="{{ testTypes }}"
            wx:key="value"
            class="option-btn {{ testType === item.value ? 'btn-active' : '' }}"
            bindtap="setTestType"
            data-type="{{ item.value }}"
            testID="testType-{{item.value}}"
          >
            {{ item.label }}
          </view>
        </view>
      </view>

      <!-- Text æ•°é‡é€‰æ‹© -->
      <view class="config-item">
        <text class="config-label">Text æ•°é‡</text>
        <view class="config-options">
          <view
            wx:for="{{ countList }}"
            wx:key="*this"
            class="option-btn {{ count === item ? 'btn-active' : '' }}"
            bindtap="setCount"
            data-count="{{ item }}"
            testID="count-{{item}}"
          >
            {{ item }}
          </view>
        </view>
      </view>
    </view>

    <view class="lifecycle-info" testID="lifecycleInfo">
      <text class="info-title">ç”Ÿå‘½å‘¨æœŸè€—æ—¶</text>
      <view class="info-row">
        <text class="info-label">æµ‹è¯•èƒ½åŠ›:</text>
        <text class="info-value" testID="currentTestType">{{ currentTypeLabel }}</text>
      </view>
      <view class="info-row">
        <text class="info-label">Text æ•°é‡:</text>
        <text class="info-value" testID="currentCount">{{ count }}</text>
      </view>
      <view class="info-row-highlight">
        <text class="info-label">{{ isBenchmarking ? 'è¿›åº¦:' : 'Created â†’ Mounted:' }}</text>
        <text class="info-value highlight-value" testID="duration">{{
          isBenchmarking ? currentRound + '/' + totalRounds : duration + 'ms'
        }}</text>
      </view>

      <!-- åŸºå‡†æµ‹è¯•ç»Ÿè®¡ç»“æœ -->
      <view wx:if="{{ benchmarkStats }}" class="stats-section" testID="benchmarkStats">
        <view class="stats-divider"></view>
        <text class="stats-title">ğŸ“Š åŸºå‡†æµ‹è¯•ç»Ÿè®¡</text>
        <view class="stats-row">
          <text class="stats-label">æµ‹è¯•è½®æ¬¡:</text>
          <text class="stats-value" testID="statsRounds"
            >{{ benchmarkStats.trimmedRounds }} (å»æå€¼å)</text
          >
        </view>
        <view class="stats-row">
          <text class="stats-label">ä¸­ä½æ•°:</text>
          <text class="stats-value stats-primary" testID="statsMedian"
            >{{ benchmarkStats.median.toFixed(2) }}ms</text
          >
        </view>
        <view class="stats-row">
          <text class="stats-label">å¹³å‡å€¼:</text>
          <text class="stats-value" testID="statsMean">{{ benchmarkStats.mean.toFixed(2) }}ms</text>
        </view>
        <view class="stats-row">
          <text class="stats-label">èŒƒå›´:</text>
          <text class="stats-value" testID="statsRange"
            >{{ benchmarkStats.min.toFixed(2) }} ~ {{ benchmarkStats.max.toFixed(2) }}ms</text
          >
        </view>
        <view class="stats-row">
          <text class="stats-label">æ ‡å‡†å·®:</text>
          <text class="stats-value" testID="statsStdDev"
            >{{ benchmarkStats.stdDev.toFixed(2) }}ms</text
          >
        </view>
        <view class="stats-row">
          <text class="stats-label">å˜å¼‚ç³»æ•°:</text>
          <text
            class="stats-value {{ benchmarkStats.cv < 10 ? 'stats-stable' : benchmarkStats.cv < 20 ? 'stats-moderate' : 'stats-unstable' }}"
            testID="statsCV"
            >
            {{ benchmarkStats.cv.toFixed(2) }}%{{
              benchmarkStats.cv < 10 ? 'âœ“ ç¨³å®š' : benchmarkStats.cv < 20 ? 'âš  ä¸€èˆ¬' : 'âœ— ä¸ç¨³å®š'
            }}</text
          >
        </view>
      </view>
    </view>

    <view class="action-section">
      <view class="btn-row">
        <view class="btn secondary" bindtap="runTest" testID="runTestBtn">
          <text class="btn-text-secondary">{{
            testing && !isBenchmarking ? 'æµ‹è¯•ä¸­...' : 'å•æ¬¡æµ‹è¯•'
          }}</text>
        </view>
        <view class="btn primary" bindtap="runBenchmark" testID="runBenchmarkBtn">
          <text class="btn-text">{{
            isBenchmarking ? 'æµ‹è¯•ä¸­ ' + currentRound + '/' + totalRounds : 'åŸºå‡†æµ‹è¯• (æ¨è)'
          }}</text>
        </view>
      </view>
      <text class="action-hint">ğŸ’¡ åŸºå‡†æµ‹è¯•ï¼š2è½®é¢„çƒ­ + 5è½®æµ‹é‡ï¼Œå–ä¸­ä½æ•°ï¼Œç»“æœæ›´ç¨³å®š</text>
    </view>

    <!-- é€šè¿‡ wx:if æ§åˆ¶å­ç»„ä»¶ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½ä¼šè§¦å‘å®Œæ•´ç”Ÿå‘½å‘¨æœŸ -->
    <view class="test-area" testID="testArea">
      <text class="area-title" testID="areaTitle">{{ currentTypeLabel }} - {{ count }} ä¸ª Text</text>
      <text-list
        wx:if="{{showComponent}}"
        count="{{count}}"
        test-type="{{testType}}"
        bindready="onComponentReady"
        testID="textList"
      />
      <view class="empty-hint" wx:else testID="emptyHint">
        <text class="hint-text">ç‚¹å‡»ã€Œå¼€å§‹æµ‹è¯•ã€æ¸²æŸ“ç»„ä»¶</text>
      </view>
    </view>
  </scroll-view>
</template>

<script setup>
import mpx, { ref, computed } from '@mpxjs/core'

// æµ‹è¯•ç±»å‹é…ç½®
const testTypes = ref([
  { label: 'Basic', value: 'basic' },
  { label: 'Simple', value: 'simple-text' },
  { label: 'Font Size', value: 'font-size' },
  { label: 'Var', value: 'var' },
  { label: 'Calc', value: 'calc' },
  { label: 'Bindtap', value: 'bindtap' },
  { label: 'Line Height', value: 'line-height' },
  { label: 'ç»¼åˆ', value: 'mixed' }
])

const testType = ref('basic')
const count = ref(100)
const testing = ref(false)
const showComponent = ref(false)
const duration = ref('0')
const countList = ref([10, 50, 100, 500, 1000])

// === æ€§èƒ½æµ‹è¯•ç¨³å®šæ€§å¢å¼º ===
const BENCHMARK_ROUNDS = 5 // æ­£å¼æµ‹é‡è½®æ¬¡
const WARMUP_ROUNDS = 2 // é¢„çƒ­è½®æ¬¡ï¼ˆç»“æœä¸è®¡å…¥ç»Ÿè®¡ï¼‰
const DESTROY_DELAY = 100 // é”€æ¯åç­‰å¾…æ—¶é—´(ms)ï¼Œç¡®ä¿ç»„ä»¶å®Œå…¨é”€æ¯

// æ ¹æ® text æ•°é‡åŠ¨æ€è®¡ç®—å†·å´æ—¶é—´
// å†·å´æ—¶é—´ = æ¸²æŸ“å®Œæˆåç­‰å¾…çš„æ—¶é—´ï¼Œè®©è®¾å¤‡çŠ¶æ€æ¢å¤ï¼ˆGCã€å†…å­˜é‡Šæ”¾ç­‰ï¼‰
// æ³¨æ„ï¼šè¿™ä¸ªæ—¶é—´æ˜¯åœ¨ onComponentReady å›è°ƒåæ‰å¼€å§‹è®¡æ—¶ï¼Œä¸ä¼šå½±å“æ¸²æŸ“
function getRoundInterval() {
  const textCount = count.value
  if (textCount <= 100) return 300 // å°‘é‡textï¼Œå†·å´300ms
  if (textCount <= 500) return 500 // ä¸­ç­‰æ•°é‡ï¼Œå†·å´500ms
  return 800 // å¤§é‡text(1000)ï¼Œå†·å´800ms
}

const benchmarkResults = ref([]) // å­˜å‚¨æ¯è½®æµ‹é‡ç»“æœ
const currentRound = ref(0) // å½“å‰è½®æ¬¡
const totalRounds = ref(0) // æ€»è½®æ¬¡ï¼ˆé¢„çƒ­+æ­£å¼ï¼‰
const isBenchmarking = ref(false) // æ˜¯å¦åœ¨è¿›è¡Œå¤šè½®æµ‹è¯•
const benchmarkStats = ref(null) // ç»Ÿè®¡ç»“æœ

// å½“å‰é€‰ä¸­ç±»å‹çš„æ ‡ç­¾
const currentTypeLabel = computed(() => {
  const type = testTypes.value.find((t) => t.value === testType.value)
  return type ? type.label : ''
})

function setTestType(e) {
  const type = e.currentTarget.dataset.type
  testType.value = type
  // åˆ‡æ¢ç±»å‹åéšè—ç»„ä»¶ï¼Œç­‰å¾…ä¸‹æ¬¡æµ‹è¯•
  showComponent.value = false
  duration.value = '0'
  resetBenchmark()
}

function setCount(e) {
  const newCount = parseInt(e.currentTarget.dataset.count)
  count.value = newCount
  // åˆ‡æ¢æ•°é‡åéšè—ç»„ä»¶ï¼Œç­‰å¾…ä¸‹æ¬¡æµ‹è¯•
  showComponent.value = false
  duration.value = '0'
  resetBenchmark()
}

// é‡ç½®æµ‹è¯•çŠ¶æ€
function resetBenchmark() {
  benchmarkResults.value = []
  currentRound.value = 0
  totalRounds.value = 0
  isBenchmarking.value = false
  benchmarkStats.value = null
}

// å•æ¬¡æµ‹è¯•ï¼ˆç”¨äºå¿«é€Ÿé¢„è§ˆï¼‰
function runTest() {
  if (testing.value || isBenchmarking.value) return

  testing.value = true
  showComponent.value = false

  // ç­‰å¾…ç»„ä»¶å®Œå…¨é”€æ¯åå†é‡æ–°åˆ›å»º
  setTimeout(() => {
    showComponent.value = true
  }, DESTROY_DELAY)
}

// å¤šè½®åŸºå‡†æµ‹è¯•ï¼ˆç”¨äºç¨³å®šçš„æ€§èƒ½æµ‹é‡ï¼‰
function runBenchmark() {
  if (testing.value || isBenchmarking.value) return

  resetBenchmark()
  isBenchmarking.value = true
  totalRounds.value = WARMUP_ROUNDS + BENCHMARK_ROUNDS

  console.log(
    `[Benchmark] Starting: ${WARMUP_ROUNDS} warmup + ${BENCHMARK_ROUNDS} benchmark rounds`
  )
  runNextRound()
}

function runNextRound() {
  currentRound.value++
  testing.value = true
  showComponent.value = false

  // ç­‰å¾…ç»„ä»¶å®Œå…¨é”€æ¯åå†é‡æ–°åˆ›å»º
  setTimeout(() => {
    showComponent.value = true
  }, DESTROY_DELAY)
}

function onComponentReady(e) {
  const detail = e.detail
  const durationValue = parseFloat(detail.duration)

  if (isBenchmarking.value) {
    const isWarmup = currentRound.value <= WARMUP_ROUNDS

    if (!isWarmup) {
      // æ­£å¼æµ‹é‡ï¼Œè®°å½•ç»“æœ
      benchmarkResults.value.push(durationValue)
    }

    console.log(
      `[Benchmark] Round ${currentRound.value}/${totalRounds.value} ${isWarmup ? '(warmup)' : ''}: ${detail.duration}ms`
    )

    if (currentRound.value < totalRounds.value) {
      // æ¸²æŸ“å®Œæˆåï¼Œç­‰å¾…å†·å´æ—¶é—´è®©è®¾å¤‡æ¢å¤ï¼Œå†è¿›å…¥ä¸‹ä¸€è½®
      testing.value = false
      const cooldownTime = getRoundInterval()
      console.log(`[Benchmark] Cooling down for ${cooldownTime}ms before next round...`)
      setTimeout(() => {
        runNextRound()
      }, cooldownTime)
    } else {
      // æ‰€æœ‰è½®æ¬¡å®Œæˆï¼Œè®¡ç®—ç»Ÿè®¡ç»“æœ
      finishBenchmark()
    }
  } else {
    // å•æ¬¡æµ‹è¯•æ¨¡å¼
    duration.value = detail.duration
    testing.value = false
    console.log(`[Single] ${detail.testType} - ${detail.count} texts: ${detail.duration}ms`)
  }
}

// è®¡ç®—ç»Ÿè®¡ç»“æœ
function finishBenchmark() {
  const results = benchmarkResults.value.slice().sort((a, b) => a - b)
  const n = results.length

  if (n === 0) {
    testing.value = false
    isBenchmarking.value = false
    return
  }

  // å»é™¤æœ€é«˜å’Œæœ€ä½å€¼ï¼ˆå¦‚æœæ ·æœ¬è¶³å¤Ÿï¼‰
  let trimmedResults = results
  if (n >= 5) {
    trimmedResults = results.slice(1, -1) // å»æ‰é¦–å°¾å„1ä¸ª
  }

  const sum = trimmedResults.reduce((a, b) => a + b, 0)
  const mean = sum / trimmedResults.length
  const median =
    trimmedResults.length % 2 === 0
      ? (trimmedResults[trimmedResults.length / 2 - 1] +
          trimmedResults[trimmedResults.length / 2]) /
        2
      : trimmedResults[Math.floor(trimmedResults.length / 2)]

  // è®¡ç®—æ ‡å‡†å·®
  const squaredDiffs = trimmedResults.map((v) => Math.pow(v - mean, 2))
  const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / trimmedResults.length
  const stdDev = Math.sqrt(avgSquaredDiff)

  // è®¡ç®—å˜å¼‚ç³»æ•° (CV = æ ‡å‡†å·®/å¹³å‡å€¼ * 100%)
  const cv = (stdDev / mean) * 100

  benchmarkStats.value = {
    rounds: n,
    trimmedRounds: trimmedResults.length,
    min: Math.min(...trimmedResults),
    max: Math.max(...trimmedResults),
    mean: mean,
    median: median,
    stdDev: stdDev,
    cv: cv,
    rawResults: results,
    trimmedResults: trimmedResults
  }

  // æ˜¾ç¤ºä¸­ä½æ•°ä½œä¸ºä¸»è¦ç»“æœï¼ˆä¸­ä½æ•°æ¯”å¹³å‡å€¼æ›´ç¨³å®šï¼‰
  duration.value = median.toFixed(2)

  console.log(`[Benchmark] ========================================`)
  console.log(`[Benchmark] Test Type: ${testType.value}`)
  console.log(`[Benchmark] Text Count: ${count.value}`)
  console.log(`[Benchmark] Rounds: ${n} (after warmup)`)
  console.log(`[Benchmark] Trimmed Rounds: ${trimmedResults.length}`)
  console.log(`[Benchmark] Raw Results: [${results.map((r) => r.toFixed(2)).join(', ')}]ms`)
  console.log(
    `[Benchmark] Trimmed Results: [${trimmedResults.map((r) => r.toFixed(2)).join(', ')}]ms`
  )
  console.log(`[Benchmark] Min: ${benchmarkStats.value.min.toFixed(2)}ms`)
  console.log(`[Benchmark] Max: ${benchmarkStats.value.max.toFixed(2)}ms`)
  console.log(`[Benchmark] Mean: ${mean.toFixed(2)}ms`)
  console.log(`[Benchmark] Median: ${median.toFixed(2)}ms`)
  console.log(`[Benchmark] Std Dev: ${stdDev.toFixed(2)}ms`)
  console.log(
    `[Benchmark] CV: ${cv.toFixed(2)}% ${cv < 10 ? 'âœ“ (stable)' : cv < 20 ? 'âš  (moderate)' : 'âœ— (unstable)'}`
  )
  console.log(`[Benchmark] ========================================`)

  testing.value = false
  isBenchmarking.value = false
}

function goBack() {
  mpx.navigateBack()
}

defineExpose({
  testTypes,
  testType,
  count,
  testing,
  showComponent,
  duration,
  countList,
  currentTypeLabel,
  benchmarkResults,
  currentRound,
  totalRounds,
  isBenchmarking,
  benchmarkStats,
  setTestType,
  setCount,
  runTest,
  runBenchmark,
  onComponentReady,
  goBack
})
</script>

<style>
.container {
  flex: 1;
  background-color: #f5f5f5;
}

.header {
  padding: 16px 20px;
  background: linear-gradient(135deg, #667eea, #764ba2);
}

.header-content {
  flex-direction: row;
  align-items: center;
}

.back-btn {
  width: 32px;
  height: 32px;
  align-items: center;
  justify-content: center;
  margin-right: 8px;
}

.back-text {
  font-size: 20px;
  color: #fff;
  font-weight: bold;
}

.title {
  font-size: 18px;
  font-weight: bold;
  color: #fff;
  flex: 1;
}

.config-section {
  padding: 16px;
  background-color: #fff;
  margin: 16px;
  border-radius: 12px;
}

.config-item {
  margin-bottom: 16px;
}

.config-label {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.config-options {
  flex-direction: row;
  flex-wrap: wrap;
}

.option-btn {
  padding: 8px 12px;
  background-color: #f0f0f0;
  border-radius: 6px;
  margin-right: 8px;
  margin-bottom: 8px;
  font-size: 13px;
  color: #333;
}

.btn-active {
  background-color: #007AFF;
  color: #fff;
}

.lifecycle-info {
  padding: 16px;
  background-color: #fff;
  margin: 0 16px 16px;
  border-radius: 12px;
}

.info-title {
  font-size: 16px;
  font-weight: bold;
  color: #333;
  margin-bottom: 12px;
}

.info-row {
  flex-direction: row;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom-width: 1px;
  border-bottom-color: #eee;
}

.info-row-highlight {
  flex-direction: row;
  justify-content: space-between;
  padding: 10px 0;
  padding-top: 12px;
  margin-top: 4px;
}

.info-label {
  font-size: 14px;
  color: #666;
}

.info-value {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.highlight-value {
  font-size: 18px;
  color: #007AFF;
  font-weight: bold;
}

/* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
.stats-section {
  margin-top: 12px;
}

.stats-divider {
  height: 1px;
  background-color: #eee;
  margin-bottom: 12px;
}

.stats-title {
  font-size: 14px;
  font-weight: bold;
  color: #333;
  margin-bottom: 8px;
}

.stats-row {
  flex-direction: row;
  justify-content: space-between;
  padding: 6px 0;
}

.stats-label {
  font-size: 13px;
  color: #888;
}

.stats-value {
  font-size: 13px;
  color: #333;
}

.stats-primary {
  font-weight: bold;
  color: #667eea;
  font-size: 15px;
}

.stats-stable {
  color: #34c759;
  font-weight: bold;
}

.stats-moderate {
  color: #ff9500;
  font-weight: bold;
}

.stats-unstable {
  color: #ff3b30;
  font-weight: bold;
}

.action-section {
  padding: 0 16px;
  margin-bottom: 16px;
}

.btn-row {
  flex-direction: row;
  justify-content: space-between;
}

.btn {
  padding: 14px;
  border-radius: 8px;
  align-items: center;
  flex: 1;
}

.primary {
  background-color: #007aff;
  margin-left: 8px;
}

.secondary {
  background-color: #f0f0f0;
  margin-right: 8px;
}

.btn-text {
  font-size: 14px;
  color: #fff;
  font-weight: bold;
}

.btn-text-secondary {
  font-size: 14px;
  color: #666;
  font-weight: bold;
}

.action-hint {
  font-size: 12px;
  color: #999;
  margin-top: 8px;
  text-align: center;
}

.test-area {
  padding: 16px;
  background-color: #fff;
  margin: 0 16px 16px;
  border-radius: 12px;
}

.area-title {
  font-size: 14px;
  color: #666;
  margin-bottom: 12px;
}

.empty-hint {
  padding: 40px 20px;
  align-items: center;
}

.hint-text {
  font-size: 14px;
  color: #999;
}
</style>

<script type="application/json">
{
  "usingComponents": {
    "text-list": "../components/text-list/index"
  },
  "navigationBarTitleText": "Text ç»„ä»¶èƒ½åŠ›æµ‹è¯•"
}
</script>
