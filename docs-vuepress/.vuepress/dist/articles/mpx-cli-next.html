<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>@mpxjs/cli 插件化改造 | Mpx框架</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon.ico">
    <script type="text/javascript">(function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "jtvvy52wxy");</script>
    <meta name="description" content="Mpxjs 是滴滴开源的支持跨端开发、深度性能优化的增强型小程序开发框架。使用 Mpxjs 帮助你更好开发小程序，拥有类似 VueJS 的数据响应能力，在降低研发心智负担的同时比原生小程序性能更好，完全基于原生小程序语法保障了最少的坑，一次开发多端生效同时支持微信小程序、支付宝小程序、抖音小程序、百度小程序、Web H5。">
    
    <link rel="preload" href="/assets/css/0.styles.f22478ca.css" as="style"><link rel="preload" href="/assets/js/app.84c88b57.js" as="script"><link rel="preload" href="/assets/js/7.01e4e942.js" as="script"><link rel="preload" href="/assets/js/3.145e69cd.js" as="script"><link rel="preload" href="/assets/js/1.4f7abe8f.js" as="script"><link rel="preload" href="/assets/js/55.2d6ae2e1.js" as="script"><link rel="preload" href="/assets/js/30.04d1a7ea.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.f22478ca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><div class="content-wrapper"><div class="container"><div class="theme-container"><header class="header" data-v-3ad594c3><!----> <div class="head-container" data-v-3ad594c3><a href="/" data-v-3ad594c3><div class="logo" data-v-3ad594c3>mpx</div></a> <div class="row" data-v-3ad594c3><div class="header__line" data-v-3ad594c3></div> <nav class="nav" data-v-3ad594c3><a href="/guide/basic/start.html" class="nav-link" data-v-3ad594c3>
          指南
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="/api/" class="nav-link" data-v-3ad594c3>
          API
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="/articles/" class="nav-link" data-v-3ad594c3>
          文章
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="https://github.com/didi/mpx/releases" target="_blank" class="nav-link" data-v-3ad594c3>
          更新记录
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="https://github.com/didi/mpx" target="_blank" class="nav-link" data-v-3ad594c3>
          GitHub
          <!----></a></nav> <div class="searchBox-wrapper" data-v-3ad594c3><div class="searchBox" data-v-3ad594c3><form id="search-form" role="search" class="algolia-search-wrapper search-box" data-v-3ad594c3><div id="docsearch-container"></div></form></div></div></div></div> <!----></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/basic/start.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/index.html" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/articles/index.html" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="https://github.com/didi/mpx/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更新记录
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/didi/mpx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/articles/1.0.html" class="sidebar-link">滴滴开源小程序框架Mpx</a></li><li><a href="/articles/2.0.html" class="sidebar-link">Mpx发布2.0，完美支持跨平台开发</a></li><li><a href="/articles/performance.html" class="sidebar-link">小程序框架运行时性能大测评</a></li><li><a href="/articles/mpx1.html" class="sidebar-link">Mpx框架初体验</a></li><li><a href="/articles/mpx2.html" class="sidebar-link">Mpx框架技术揭秘</a></li><li><a href="/articles/size-control.html" class="sidebar-link">基于Mpx的小程序体积优化</a></li><li><a href="/articles/ts-derivation.html" class="sidebar-link">Mpx中基于 Typescript Template Literal Types 实现链式key的类型推导</a></li><li><a href="/articles/2.7-release.html" class="sidebar-link">Mpx2.7 版本正式发布，大幅提升编译构建速度</a></li><li><a href="/articles/2.8-release.html" class="sidebar-link">Mpx2.8 版本正式发布，使用组合式 API 开发小程序</a></li><li><a href="/articles/2.9-release.html" class="sidebar-link">Mpx2.9 版本正式发布，支持原子类、SSR 和包体积优化</a></li><li><a href="/articles/mpx-cube-ui.html" class="sidebar-link">小程序跨端组件库 Mpx-cube-ui 开源啦</a></li><li><a href="/articles/mpx-cli-next.html" aria-current="page" class="active sidebar-link">Mpx-cli 插件化改造</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/mpx-cli-next.html#背景-现状" class="sidebar-link">背景 &amp; 现状</a></li><li class="sidebar-sub-header"><a href="/articles/mpx-cli-next.html#mpxjs-cli-2-x-自身的痛点" class="sidebar-link">mpxjs/cli@2.x 自身的痛点</a></li><li class="sidebar-sub-header"><a href="/articles/mpx-cli-next.html#插件化改造方案" class="sidebar-link">插件化改造方案</a></li><li class="sidebar-sub-header"><a href="/articles/mpx-cli-next.html#没有银弹" class="sidebar-link">没有银弹</a></li><li class="sidebar-sub-header"><a href="/articles/mpx-cli-next.html#如何开发一个基于-mpx-的业务脚手架插件" class="sidebar-link">如何开发一个基于 mpx 的业务脚手架插件</a></li></ul></li><li><a href="/articles/unit-test.html" class="sidebar-link">Mpx 小程序单元测试能力建设与实践</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mpxjs-cli-插件化改造"><a href="#mpxjs-cli-插件化改造" class="header-anchor">#</a> @mpxjs/cli 插件化改造</h1> <p><a href="https://github.com/mpx-ecology/mpx-cli" target="_blank" rel="noopener noreferrer">@mxpjs/cli 地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="背景-现状"><a href="#背景-现状" class="header-anchor">#</a> 背景 &amp; 现状</h2> <p>Mpx 脚手架 <code>@mpxjs/cli</code> 作为 Mpx 生态当中比较重要的一部分，是使用 Mpx 进行小程序开发的入口。</p> <p><code>@mpxjs/cli@2.x</code> 版本整体是基于模板配置的方式完成项目的初始化，整个的工作流是：</p> <ol><li><p>下载一份存放于远端的 mpx 项目原始模板（mpx-template）</p></li> <li><p>根据用户的 prompts 选项完成用户选项的注入，并初始化最终的项目文件</p></li></ol> <p>完成项目的初始化后，除了一些基础配置文件外，整个项目的文件主要包含了如下的结构：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">--</span> mpx<span class="token operator">-</span>project
 <span class="token operator">|</span><span class="token operator">--</span> src <span class="token comment">// 项目源码</span>
 <span class="token operator">|</span><span class="token operator">--</span> config <span class="token comment">// 项目配置文件</span>
   <span class="token operator">|</span><span class="token operator">--</span> index<span class="token punctuation">.</span>js <span class="token comment">// 配置入口文件</span>
   <span class="token operator">|</span><span class="token operator">--</span> mpxLoader<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>js <span class="token comment">// mpx-loader 配置</span>
   <span class="token operator">|</span><span class="token operator">--</span> mpxPlugin<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>js <span class="token comment">// mpx webpack-plugin 配置</span>
   <span class="token operator">|</span><span class="token operator">--</span> user<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>js <span class="token comment">// 用户的 prompts 选择信息</span>
 <span class="token operator">|</span><span class="token operator">--</span> build <span class="token comment">// 编译构建配置</span>
   <span class="token operator">|</span><span class="token operator">--</span> build<span class="token punctuation">.</span>js <span class="token comment">// 构建编译脚本</span>
   <span class="token operator">|</span><span class="token operator">--</span> getPlugins<span class="token punctuation">.</span>js <span class="token comment">// webpack plugins </span>
   <span class="token operator">|</span><span class="token operator">--</span> getRules<span class="token punctuation">.</span>js <span class="token comment">// webpack module rules</span>
   <span class="token operator">|</span><span class="token operator">--</span> getWebpackConf<span class="token punctuation">.</span>js <span class="token comment">// webpack 配置生成辅助函数</span>
   <span class="token operator">|</span><span class="token operator">--</span> utils<span class="token punctuation">.</span>js <span class="token comment">// 工具函数</span>
   <span class="token operator">|</span><span class="token operator">--</span> webpack<span class="token punctuation">.</span>base<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>js <span class="token comment">// webpack 基础配置</span>
</code></pre></div><p>在初始化的项目当中，有关项目的所有配置文件，编译构建代码是全部暴露给开发者的，开发者可以对这些文件进行修改来满足自己实际的项目开发需要。同时还可以基于这一套原始的模板文件二次拓展为满足自己业务场景的模板。</p> <p><strong>基于远程模板初始化项目的方式最大的一个好处就是将项目所有的底层配置完全暴露给开发者，开发者可以任意去修改对应的配置。</strong></p> <h2 id="mpxjs-cli-2-x-自身的痛点"><a href="#mpxjs-cli-2-x-自身的痛点" class="header-anchor">#</a> <code>mpxjs/cli@2.x</code> 自身的痛点</h2> <p>目前 <code>@mpxjs/cli@2.x</code> 采用这种基于模板的方式面临着两方面的痛点：</p> <ol><li>对于 <code>@mpxjs/cli</code> 的使用者而言：</li></ol> <ul><li><p>模板和业务项目割裂：远程模板没有严格的版本控制，用户无法感知到远程模板的更新变化；</p></li> <li><p>项目升级困难：对于用户来说没有一个很好的方式完成升级工作，基本只能通过 copy 代码的方式，将 <code>mpx-template</code> 更新后的内容复制一份到自己的项目当中；或者是通过脚手架重新创建一个新的项目，将老的代码迁移到新项目当中；</p></li> <li><p>项目结构臃肿：从项目结构角度来说没法做到按需，初始化代码臃肿。Mpx 支持了小程序跨平台、跨端、小程序插件等等相关的开发，不同的编译构建配置都需要全部生成，在运行时阶段才能决定是否启动对应的功能；</p></li> <li><p>跨 Web 构建能力弱：在基于 Mpx 的跨 Web 场景构建中有关 <code>web</code> 侧的编译构建的配置是比较初级的，像 <code>MPA 多页应用</code> 等比较常用的功能是需要用户重新去手动搭建一套的；</p></li> <li><p>可拓展性差，基于目前的模板拉取的方式无法满足多样化的业务需求场景迭代；</p></li></ul> <ol start="2"><li>对于 <code>@mpxjs/cli</code> 的开发者而言：</li></ol> <ul><li>分支场景多，功能模块耦合度高：脚手架的所有功能全部集合到一个大的模板当中。各部分的能力都是耦合在一起，为了满足不同项目的实际开发需要，代码里面需要写比较多的 <code>if...else...</code> 判断逻辑来决定要开启哪些功能，生成哪部分的模板；</li> <li>长期可维护性差，开发心智负担重；</li></ul> <p><strong>针对以上问题，通过调研业内一些优秀的脚手架工具，发现 <code>@vue/cli</code> 插件化的架构设计能很好的去解决我们以上所遇到的问题。核心思路是将 <code>@vue/cli</code> 作为 <code>@mpxjs/cli</code> 底层的引擎，收敛 Mpx 对于核心依赖管理、模板、构建配置的能力，充分利用 <code>@vue/cli</code> 提供的插件机制去构建、拓展上层的插件集。</strong></p> <h3 id="有关-vue-cli"><a href="#有关-vue-cli" class="header-anchor">#</a> 有关 <code>@vue/cli</code></h3> <p>简单介绍下 <code>@vue/cli</code> 的插件化架构：</p> <p><code>@vue/cli@3.x</code> 相较于 <code>2.x</code> 版本相比，整个 <code>@vue/cli</code> 的架构发生了非常大的变化，从基于模板的脚手架迭代为基于插件化的脚手架。简单的概述下整个插件化的构架就是：</p> <p><img src="https://dpubstatic.udache.com/static/dpubimg/zfUXzzdOptIviAJ15AgSn_cli-3.png" alt="mpx-cli-3"></p> <ul><li><p>@vue/cli 提供 vue cli 命令，负责偏好设置，生成模板、<code>vue-cli-plugin</code> 插件依赖管理的工作，例如 <code>vue create &lt;projectName&gt;</code>、<code>vue add &lt;pluginName&gt;</code>；</p></li> <li><p>@vue/cli-service 作为 @vue/cli 整个插件系统当中的内部核心插件，提供了 npm script 注册服务，内置了部分 webpack 配置的同时，又提供了 <code>vue-cli-plugin</code> 插件的导入、加载以及 webpack 配置更新服务等。</p></li></ul> <p>以上是 <code>@vue/cli</code> 生态当中最为核心的两部分内容，二者分工明确，各司其职。</p> <p>此外在 <code>@vue/cli</code> 生态当中非常重要的一个点就是 <code>vue-cli-plugin</code> 插件，每个插件主要完成模板生成及生产编译构建配置。根据 <code>@vue/cli</code> 设计的规范，开发一个 <code>vue-cli-plugin</code> 需要遵照<strong>相关的约定</strong>来进行开发：</p> <ul><li><p>@vue/cli <strong>约定</strong>插件如果要生成模板，那么需要提供 <code>generator</code> 入口文件；</p></li> <li><p>@vue/cli-service <strong>约定</strong>插件的 <code>webpack</code> 配置更新需要放到插件的入口文件当中来完成，同时插件的命名也需要包含 <code>vue-cli-plugin</code> 前缀，因为 @vue/cli-service 是依据命名来加载相关的插件的；</p></li></ul> <h2 id="插件化改造方案"><a href="#插件化改造方案" class="header-anchor">#</a> 插件化改造方案</h2> <p>一张图了解下插件化改造之后的 <code>@mpxjs/cli</code> 的架构设计：</p> <p><img src="https://dpubstatic.udache.com/static/dpubimg/hNaL_GUMzUVLOsyY5quGE_cli-2.png" alt="mpx-cli-2"></p> <h3 id="底层能力"><a href="#底层能力" class="header-anchor">#</a> 底层能力</h3> <p>将 <code>@vue/cli</code>、<code>@vue/cli-service</code> 分别作为 <code>@mpx/cli</code>和 <code>@mpx/cli-service</code> 的底层能力，即利用插件化的架构设计，同时还非常灵活的满足了 Mpx 做差异化场景迭代的定制化改造。上层的插件满足 <code>vue-cli-plugin</code> 插件开发的规范，最终底层的能力还是依托于 <code>@vue/cli</code> 和 <code>@vue/cli-service</code> 进行工作。</p> <h3 id="上层插件拆分"><a href="#上层插件拆分" class="header-anchor">#</a> 上层插件拆分</h3> <p>将原本大而全的模板进行插件化拆分，从 Mpx 所要解决的问题以及设计思路来考虑，站在跨平台的角度：</p> <ol><li>web 开发</li></ol> <ul><li>基于 <code>wx</code> 的跨 <code>web</code> 开发；</li></ul> <ol start="2"><li>小程序开发</li></ol> <ul><li>基于 <code>wx</code> 的跨平台(<code>ali</code>、<code>swan</code>，<code>tt</code>，<code>dd</code>)的小程序开发；</li> <li>使用云函数的微信小程序开发；</li> <li>微信小程序的插件模式的开发；</li></ul> <p>一个项目可能只需要某一种开发模式，例如仅仅是微信小程序的插件模式开发，也有可能是小程序和web平台混合开发等等，不同的开发模式对应了：</p> <ol><li><p><strong>不同的目录结构</strong>；</p></li> <li><p><strong>不同的编译构建配置</strong></p></li></ol> <hr> <p>基于这样一种现状以及 <code>@mpxjs/cli</code> 所要解决的问题，从跨平台的角度出发将功能进行了拆分，最终拆解为如下的9个插件：</p> <ul><li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（mpx 基础开发插件）</p></li> <li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx-mp" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx-mp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（mpx 小程序平台开发插件）</p></li> <li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx-web" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx-web<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（mpx 跨 web 平台开发插件）</p></li> <li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx-cloud-func" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx-cloud-func<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（微信小程序云函数开发插件）</p></li> <li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx-plugin-mode" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx-plugin-mode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（微信小程序插件模式开发插件）</p></li> <li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx-eslint" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx-eslint<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（mpx eslint 插件）</p></li> <li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx-unit-test" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx-unit-test<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（小程序单元测试插件）</p></li> <li><p><a href="https://github.com/mpx-ecology/mpx-cli/tree/master/packages/vue-cli-plugin-mpx-typescript" target="_blank" rel="noopener noreferrer">vue-cli-plugin-mpx-typescript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（mpx typescript 插件）</p></li></ul> <p>这些拆解出来的插件都将和功能相关的<strong>项目模板</strong>以及<strong>编译构建</strong>配置进行了收敛。</p> <p>项目模板的生成不用说，借助 <code>@vue/cli</code> 的 <code>Generator API</code> 按需去生成项目开发所需要的模板，例如项目需要使用 <code>eslint</code> 的功能，那么在生成项目的时候会生成对应 <code>vue-cli-plugin-mpx-eslint</code> 所提供的模板文件，如果不需要使用，项目当中最终也不会出现和 <code>eslint</code> 相关的文件配置。</p> <p>重点说下编译构建的配置是如何进行拆解的：</p> <p><strong>在 <code>@vue/cli@3.x</code> 基于插件的架构设计当中，决定是否要使用某个插件的依据就是判断这个插件是否被你的项目所安装</strong>和基于模板的构架相比最大的区别就是：基于模板的架构在最终生成的模板配置里需要保存一些环境配置文件，以供编译构建的运行时来判断是否启用某些功能。但是基于插件的架构基本上是不再需要这些环境配置文件的，因为你如果要使用一个插件的功能，只需要安装它即可。</p> <p>因此依照这样的设计规范，我们将：</p> <ul><li><p><code>eslint</code></p></li> <li><p><code>unit-test</code></p></li> <li><p><code>typescript</code></p></li></ul> <p>这些非常独立的功能都单独抽离成了可拔插的插件，安装即启用。</p> <p>以上功能有个特点就是和平台是完全解耦的，所以在拆解的过程中可以拆的比较彻底。但是由于 <code>mpx</code> 项目的特殊性，即要支持基于 <code>wx</code> 小程序的跨端以及 <code>web</code> 开发，同时还要支持小程序的云函数、小程序插件模式的开发，且不同开发模式的编译构建配置都有些差异。可以用如下的集合图来表示他们之间的关系：</p> <p><img src="https://dpubstatic.udache.com/static/dpubimg/3bgI4GSZ09ai4G1C3TDtr_cli-4.png" alt="mpx-cli-4"></p> <p>不同插件进行组合使用来满足不同场景下的使用。</p> <p>在不同平台开发模式下是有 <code>mpx</code> 编译构建的基础配置的，这个是和平台没有太多关系，因此将这部分的配置单独抽离为一个插件：<code>vue-cli-plugin-mpx</code>，<strong>同时这个插件也被置为了 <code>@mpxjs/cli</code> 的 <code>preset</code> 预设插件，不管任何项目开发模式下，这个插件都会被默认的安装</strong>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// vue-cli-plugin-mpx</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options<span class="token punctuation">,</span> webpackConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  webpackConfig<span class="token punctuation">.</span>module
    <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.json$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">resourceQuery</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">asScript</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'javascript/auto'</span><span class="token punctuation">)</span>

  webpackConfig<span class="token punctuation">.</span>module
    <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'wxs-pre-loader'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(wxs|qs|sjs|filter\.js)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'mpx-wxs-pre-loader'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span>MpxWebpackPlugin<span class="token punctuation">.</span><span class="token function">wxsPreLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>loader<span class="token punctuation">)</span>

  <span class="token keyword">const</span> transpileDepRegex <span class="token operator">=</span> <span class="token function">genTranspileDepRegex</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>transpileDependencies <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  webpackConfig<span class="token punctuation">.</span>module
    <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>include
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">filepath</span> <span class="token operator">=&gt;</span> transpileDepRegex <span class="token operator">&amp;&amp;</span> transpileDepRegex<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">filepath</span> <span class="token operator">=&gt;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.mpx\.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 处理 mpx 转 web 的情况，vue-loader 会将 script block fake 出一个 .mpx.js 路径，用以 loader 的匹配</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules/@mpxjs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> transpileDepRegex <span class="token operator">=</span> <span class="token function">genTranspileDepRegex</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>transpileDependencies<span class="token punctuation">)</span>
  webpackConfig<span class="token punctuation">.</span>module
    <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>include
      <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">filepath</span> <span class="token operator">=&gt;</span> transpileDepRegex <span class="token operator">&amp;&amp;</span> transpileDepRegex<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules/@mpxjs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span>

  webpackConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>extensions
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'.mpx'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'.wxml'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'.ts'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span>

  webpackConfig<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在小程序的开发模式下，<code>vue-cli-plugin-mpx-mp</code> 会在 <code>vue-cli-plugin-mpx</code> 的基础上去拓展 <code>webpack</code> 配置以满足小程序的编译构建。</p> <p>在跨 web 的开发模式下，<code>vue-cli-plugin-mpx-web</code> 会在 <code>vue-cli-plugin-mpx</code> 和 <code>@vue/cli</code> 的基础上去拓展配置以满足 web 侧的开发编译构建。</p> <h3 id="web-平台编译构建能力增强"><a href="#web-平台编译构建能力增强" class="header-anchor">#</a> Web 平台编译构建能力增强</h3> <p>在 <code>@mpxjs/cli@2.x</code> 版本当中有关 <code>web</code> 侧的编译构建的配置是比较初级的，像 <code>热更新</code>、<code>MPA 多页应用</code> 等比较常用的功能是需要用户重新去手动搭建一套的。而 <code>@vue/cli@3.x</code> 即为 <code>vue</code> 项目而生，提供了非常完备的 <code>web</code> 应用的编译构建打包配置。</p> <p><strong>所以 <code>@mpxjs/cli@next</code> 版本里面做了一项非常重要的工作就是复用 <code>@vue/cli</code> 的能力，弥补 <code>mpx</code> 项目在跨 <code>web</code> 项目编译构建的不足。</strong></p> <p>因此关于 <code>mpx</code> 跨 <code>web</code> 编译构建的部分也单独抽离为一个插件：<code>vue-cli-plugin-mpx-web</code>，这个插件所做的工作就是在 <code>@vue/cli</code> 提供的 <code>web</code> 编译构建的能力上去适配 <code>mpx</code> 项目。这样也就完成了 <code>mpx</code> 跨 <code>web</code> 项目编译构建能力的增强。</p> <p><strong>这也意味着 <code>@vue/cli</code> 所提供的能力基本上在 mpx 跨 web 项目当中都可使用。</strong></p> <h3 id="项目配置拓展能力"><a href="#项目配置拓展能力" class="header-anchor">#</a> 项目配置拓展能力</h3> <p>在 <code>@mpxjs/cli@2.x</code> 版本的项目如果要进行配置拓展，基本需要进行以下2个步骤：</p> <ol><li><p>对 <code>config</code> 文件夹下的相关的配置文件进行修改；</p></li> <li><p>对 <code>build</code> 文件夹下的编译构建配置文件进行修改；</p></li></ol> <p>这也是在文章一开始的时候就提到的基于模板的大而全的文件组织方式。</p> <p>而在 <code>@mpxjs/cli@next</code> 版本当中，将项目的配置拓展全部收敛至 <code>vue.config.js</code> 文件当中去完成，同时减少了开发者需要了解项目结构的心智负担。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// vue.config.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">pluginOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mpx</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">plugin</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// mpx-plugin 相关的配置</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// mpx-loader 相关的配置</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">configureWebpack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">chainWebpack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自定义的 webpack 配置</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="改造后的目录结构"><a href="#改造后的目录结构" class="header-anchor">#</a> 改造后的目录结构</h3> <p>在第一章节展示了目前 <code>@mpxjs/cli@2.x</code> 初始化项目的结构和现状。经过这次的插件化的改造后，项目的结构变得更为简洁，开发者只需要关注 <code>src</code> 源码目录以及 <code>vue.config.js</code> 配置文件即可：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">--</span> mpx<span class="token operator">-</span>project
 <span class="token operator">|</span><span class="token operator">--</span>src
 <span class="token operator">|</span><span class="token operator">--</span>vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js 
</code></pre></div><h2 id="没有银弹"><a href="#没有银弹" class="header-anchor">#</a> 没有银弹</h2> <p>虽然基于 <code>@vue/cli</code> 插件的架构模式完成了 <code>@mpxjs/cli@3.x</code> 的插件化改造升级。但是由于 <code>mpx</code> 项目开发的一些特殊性，不同插件之间的协同工作是有一些约定的。</p> <p>例如 <code>@vue/cli-service</code> 内置了一些 <code>webpack</code> 的配置，因为 <code>@vue/cli</code> 是专门针对 <code>web</code>应用的，这些配置会在所有的编译构建流程当中生效，不过这些配置当中有些对于小程序的开发来说是不需要的。</p> <p>那么针对这种情况，为了避免不同模式下的 <code>webpack</code> 配置相互污染。<code>web</code> 侧的编译构建还是基于 <code>@vue/cli</code> 提供的能力去适配 <code>mpx</code> 的 <code>web</code> 开发。而小程序侧的编译构建配置是通过 <code>@vue/cli-service</code> 内部暴露出来的一些方法去跳过一些对于小程序开发来说不需要的 <code>webpack</code> 配置来最终满足小程序的构建配置。</p> <p>因此在各插件的开发当中，需要暴露该插件所应用的平台：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>export<span class="token punctuation">.</span>platform <span class="token operator">=</span> <span class="token string">'mp'</span>  <span class="token comment">// 可选值： 'web'</span>
</code></pre></div><p>这样在实际的构建过程当中通过平台的标识来决定对应哪些插件会生效。</p> <h2 id="如何开发一个基于-mpx-的业务脚手架插件"><a href="#如何开发一个基于-mpx-的业务脚手架插件" class="header-anchor">#</a> 如何开发一个基于 mpx 的业务脚手架插件</h2> <p>具体参阅<a href="https://github.com/mpx-ecology/mpx-cli/blob/master/PLUGIN_GUIDE.md" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/mpx-cube-ui.html" class="prev">
        小程序跨端组件库 Mpx-cube-ui 开源啦
      </a></span> <span class="next"><a href="/articles/unit-test.html">
        Mpx 小程序单元测试能力建设与实践
      </a>
      →
    </span></p></div> </main></div></div></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.84c88b57.js" defer></script><script src="/assets/js/7.01e4e942.js" defer></script><script src="/assets/js/3.145e69cd.js" defer></script><script src="/assets/js/1.4f7abe8f.js" defer></script><script src="/assets/js/55.2d6ae2e1.js" defer></script><script src="/assets/js/30.04d1a7ea.js" defer></script>
  </body>
</html>
