<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mpx 小程序单元测试能力建设与实践 | Mpx框架</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon.ico">
    <script type="text/javascript">(function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "jtvvy52wxy");</script>
    <meta name="description" content="Mpxjs 是滴滴开源的支持跨端开发、深度性能优化的增强型小程序开发框架。使用 Mpxjs 帮助你更好开发小程序，拥有类似 VueJS 的数据响应能力，在降低研发心智负担的同时比原生小程序性能更好，完全基于原生小程序语法保障了最少的坑，一次开发多端生效同时支持微信小程序、支付宝小程序、抖音小程序、百度小程序、Web H5。">
    
    <link rel="preload" href="/assets/css/0.styles.f22478ca.css" as="style"><link rel="preload" href="/assets/js/app.84c88b57.js" as="script"><link rel="preload" href="/assets/js/7.01e4e942.js" as="script"><link rel="preload" href="/assets/js/3.145e69cd.js" as="script"><link rel="preload" href="/assets/js/1.4f7abe8f.js" as="script"><link rel="preload" href="/assets/js/62.4bf212f9.js" as="script"><link rel="preload" href="/assets/js/30.04d1a7ea.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.f22478ca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><div class="content-wrapper"><div class="container"><div class="theme-container"><header class="header" data-v-3ad594c3><!----> <div class="head-container" data-v-3ad594c3><a href="/" data-v-3ad594c3><div class="logo" data-v-3ad594c3>mpx</div></a> <div class="row" data-v-3ad594c3><div class="header__line" data-v-3ad594c3></div> <nav class="nav" data-v-3ad594c3><a href="/guide/basic/start.html" class="nav-link" data-v-3ad594c3>
          指南
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="/api/" class="nav-link" data-v-3ad594c3>
          API
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="/articles/" class="nav-link" data-v-3ad594c3>
          文章
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="https://github.com/didi/mpx/releases" target="_blank" class="nav-link" data-v-3ad594c3>
          更新记录
          <!----></a></nav><nav class="nav" data-v-3ad594c3><a href="https://github.com/didi/mpx" target="_blank" class="nav-link" data-v-3ad594c3>
          GitHub
          <!----></a></nav> <div class="searchBox-wrapper" data-v-3ad594c3><div class="searchBox" data-v-3ad594c3><form id="search-form" role="search" class="algolia-search-wrapper search-box" data-v-3ad594c3><div id="docsearch-container"></div></form></div></div></div></div> <!----></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/basic/start.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/index.html" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/articles/index.html" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="https://github.com/didi/mpx/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更新记录
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/didi/mpx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/articles/1.0.html" class="sidebar-link">滴滴开源小程序框架Mpx</a></li><li><a href="/articles/2.0.html" class="sidebar-link">Mpx发布2.0，完美支持跨平台开发</a></li><li><a href="/articles/performance.html" class="sidebar-link">小程序框架运行时性能大测评</a></li><li><a href="/articles/mpx1.html" class="sidebar-link">Mpx框架初体验</a></li><li><a href="/articles/mpx2.html" class="sidebar-link">Mpx框架技术揭秘</a></li><li><a href="/articles/size-control.html" class="sidebar-link">基于Mpx的小程序体积优化</a></li><li><a href="/articles/ts-derivation.html" class="sidebar-link">Mpx中基于 Typescript Template Literal Types 实现链式key的类型推导</a></li><li><a href="/articles/2.7-release.html" class="sidebar-link">Mpx2.7 版本正式发布，大幅提升编译构建速度</a></li><li><a href="/articles/2.8-release.html" class="sidebar-link">Mpx2.8 版本正式发布，使用组合式 API 开发小程序</a></li><li><a href="/articles/2.9-release.html" class="sidebar-link">Mpx2.9 版本正式发布，支持原子类、SSR 和包体积优化</a></li><li><a href="/articles/mpx-cube-ui.html" class="sidebar-link">小程序跨端组件库 Mpx-cube-ui 开源啦</a></li><li><a href="/articles/mpx-cli-next.html" class="sidebar-link">Mpx-cli 插件化改造</a></li><li><a href="/articles/unit-test.html" aria-current="page" class="active sidebar-link">Mpx 小程序单元测试能力建设与实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/unit-test.html#什么是单元测试" class="sidebar-link">什么是单元测试</a></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#前端单元测试" class="sidebar-link">前端单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/unit-test.html#前端单元测试工具" class="sidebar-link">前端单元测试工具</a></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#测试断言库" class="sidebar-link">测试断言库</a></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#jest-框架简介" class="sidebar-link">Jest 框架简介</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#小程序单元测试" class="sidebar-link">小程序单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/unit-test.html#与-web-应用的不同" class="sidebar-link">与 web 应用的不同</a></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#小程序单测框架整体流程" class="sidebar-link">小程序单测框架整体流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#mpx-框架单元测试" class="sidebar-link">Mpx 框架单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/unit-test.html#初期版本" class="sidebar-link">初期版本</a></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#优化版本" class="sidebar-link">优化版本</a></li></ul></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#mpx组件单元测试实战" class="sidebar-link">Mpx组件单元测试实战</a></li><li class="sidebar-sub-header"><a href="/articles/unit-test.html#结语" class="sidebar-link">结语</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mpx-小程序单元测试能力建设与实践"><a href="#mpx-小程序单元测试能力建设与实践" class="header-anchor">#</a> Mpx 小程序单元测试能力建设与实践</h1> <blockquote><p>作者：<a href="https://github.com/Blackgan3" target="_blank" rel="noopener noreferrer">Blackgan3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="什么是单元测试"><a href="#什么是单元测试" class="header-anchor">#</a> 什么是单元测试</h2> <p>In computer programming, unit testing is a software testing method by which individual units of source code—sets of one or more computer program modules together with associated control data, usage procedures, and operating procedures—are tested to determine whether they are fit for use wikipedia</p> <p>对一个函数，模块，类进行运行结果正确性检验的工作就是单元测试，此外每个单元测试的对象应该是一个最简单的组件/函数。</p> <p>那写单测又能给我们哪些收益呢？</p> <ul><li>大幅提高项目代码可维护性</li> <li>覆盖率到达一定指标后可大幅提高研发效率</li> <li>让你的代码零线上bug锐减，上线不再提心吊胆</li> <li>改进设计，促进重构</li></ul> <p>此外，单测高覆盖率的项目也会给公司节省大量支出：
<img src="https://cdn.nlark.com/yuque/0/2021/png/116604/1640872105786-b7b230b4-7f65-4a0f-8dbf-e8ba89f61837.png" alt="unit-test-money.png">
据微软统计单测效益结果，如上图展示，绝大多数bug都是在coding阶段产生，并且随着需求开发进度的推进，修复bug的成本会随指数级增长，当我们在unit test阶段发现并修复这个bug是能给公司带来巨大收益的。</p> <p>下方介绍两种常见的项目单元测试规范：</p> <ul><li>TDD (Test driven development)</li></ul> <blockquote><p>测试驱动开发，在书写业务代码之前，先根据需求进行单元功能测试用例书写</p></blockquote> <p>这里驱动开发的不是简单的测试用例，是能够持续验证、重构并且对需求功能极致细化的测试用例</p> <ul><li>BDD (Behavior driven development)</li></ul> <blockquote><p>行为驱动开发，通过具有辨识力的测试用例驱动项目开发团队所有人，使用自然语言来描述功能，一般和 TDD 相结合，针对行为进行测试，让开发者在写单测时从专注代码实现转为业务行为，能使单测更加场景化和智能化</p></blockquote> <p>单元测试的书写初期必定伴随着大量精力与时间的消耗，但长期持续维护的业务在搭建并完善好整个单元测试体系后，可大大提高项目稳定性和研发效率</p> <h2 id="前端单元测试"><a href="#前端单元测试" class="header-anchor">#</a> 前端单元测试</h2> <h3 id="前端单元测试工具"><a href="#前端单元测试工具" class="header-anchor">#</a> 前端单元测试工具</h3> <p>前端单元测试目前有很多框架和工具，我们下方列出三个较为流行的框架和工具库进行介绍</p> <ul><li>Mocha: 功能丰富的 javascript 测试框架(不包括断言和仿真环境，快照测试需额外配置)，可以运行在node.js和浏览器中</li> <li>Jasmine：Behavior-Drive development(BDD)风格的测试框架，在业内较为流行,功能很全面，自带asssert、mock功能</li> <li>Jest：一个功能全面的 javascript 测试框架，基于Jasmine 做了大量新特性(例如并行执行、源代码改动感知等)，开箱即用，适用于绝大多数 js 项目</li></ul> <h3 id="测试断言库"><a href="#测试断言库" class="header-anchor">#</a> 测试断言库</h3> <p>在单测运行框架中，我们需要断言库来进行方法返回和实例状态的正确性验证</p> <ul><li>should: BDD风格断言                    (true).should.be.ok</li> <li>expect: expect()样式断言              expect(true).toBe(true)</li> <li>assert: Node.js 内置断言模块       assert(true === true)</li> <li>chai: expect()，assert()和should风格的断言都支持，全能型选手</li></ul> <p>在众多前端单元测试框架中，Jest 目前凭借零配置，高性能，且对于断言，快照，覆盖率等都有很好的集成，是目前较为流行的一个单测框架</p> <h3 id="jest-框架简介"><a href="#jest-框架简介" class="header-anchor">#</a> Jest 框架简介</h3> <p>简单来看下 Jest 框架的特点以及大致的运行原理</p> <p><strong>Jest 的整体框架特点大概归纳总结为以下几点:</strong></p> <ul><li>在操作系统上高效的进行文件搜索以及相互依赖关系匹配</li> <li>单测并行执行，运行效率高</li> <li>内置断言库、覆盖率、快照测试等功能，开箱可用</li> <li>使用 vm 来进行沙盒环境运行，单测之间相互隔离</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/116604/1639153318989-0e6ac9ed-75a3-4874-8a48-5370db55891d.png#averageHue=%23464a4d&amp;clientId=uf375a834-bd4b-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=579&amp;id=u7fb4026f&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=2014&amp;originWidth=777&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=495531&amp;status=done&amp;style=none&amp;taskId=u6e39efb8-e12a-49b0-b8ce-ade9b63fd2c&amp;title=&amp;width=223.5" alt="image.png">
打开 Jest pacakges，可以看到大概有50多个包，我们根据这些不同的包来将整个 jest 运行流程整体串起来</p> <p><strong>第一步 jest-cli 读取相关配置</strong>
当我们执行 jest 命令时，先去执行 jest-cli 中的 run 方法，再调用 jest-core 中的 runCli 方法，其中通过 jest-config 提供的 readConfigs 来读取 Jest 相关配置，返回全局配置(globalConfig)和局部配置(configs)</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/116604/1640502186276-2a1c2976-58a5-4fd9-91db-c5df8265fc7f.png#clientId=u3d4e127e-cc05-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=161&amp;id=uc6c948fd&amp;margin=%5Bobject%20Object%5D&amp;name=unit-test-jest-step1.png&amp;originHeight=177&amp;originWidth=808&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=23884&amp;status=done&amp;style=none&amp;taskId=ub778d79f-2480-411f-97c3-d13aed04965&amp;title=&amp;width=735" alt="unit-test-jest-step1.png"></p> <p><strong>第二步 文件静态分析</strong>
使用 jest-haste-map 来进行项目中所有文件的检索以及生成文件之间的相互依赖关系，在 jest-core 中的 _run10000 方法中执行 buildContextsAndHasteMaps，返回 contexts 和 hasteMapInstances，contexts 中的 hasteFs 存储的就是文件及依赖关系。</p> <p>**jest-haste-map **检索的过程中借助 jest-worker 来根据当前cpu核数并行的进行文件检索，借助 fb-watch-man/crawler 对整体文件变动做实时监听，做到只执行有改动的单元测试文件，实现单测缓存效果。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/116604/1640524931986-a0ee9e99-151b-464e-96f3-c5d403a258f5.png#clientId=u059512e6-4582-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=555&amp;id=u042b30bc&amp;margin=%5Bobject%20Object%5D&amp;name=unit-test-jest-haste.png&amp;originHeight=1109&amp;originWidth=2131&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=188410&amp;status=done&amp;style=none&amp;taskId=u0c46aead-c2c6-4bd4-a90a-cf1e8cce042&amp;title=&amp;width=1065.5" alt="unit-test-jest-haste.png">
下方看一个简单的jest-haste-map使用示例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> JestHasteMap <span class="token keyword">from</span> <span class="token string">'jest-haste-map'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>cpus<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'os'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hasteMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JestHasteMap<span class="token punctuation">.</span>default</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maxWorkers</span><span class="token operator">:</span> <span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">platforms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>hasteFS<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> hasteMap<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> testFiles <span class="token operator">=</span> hasteFS<span class="token punctuation">.</span><span class="token function">getAllFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>testFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ['/path/to/tests/list1.spec.js', '/path/to/tests/list2.spec.js', …]</span>
</code></pre></div><p><strong>第三步 单测检索和排序</strong>
经过第一步和第二步，我们拿到了 <strong>配置对象 configs</strong>，以及<strong>文件Map HasteContext</strong>，接下来通过 SearchSource 对象检索出所有的单元测试到一个数组中，检索出单元测试文件后，在正式执行之前，我们需要先对当前拿到的所有单测进行权重优先级排序。</p> <p>单测排序的工作是由 jest Sequencer 完成的，默认排序优先级为 failed (上次失败的先运行)&gt; duration(耗时长的先运行) &gt; size(文件体积大的先运行)，当然这里我们也可以自定义customSequencer来覆盖 jest 默认的排序规则，jest 排序规则如下。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/116604/1640525025246-045963f5-1df6-411c-9257-74359f05e235.png#clientId=u059512e6-4582-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=802&amp;id=u61d4057e&amp;margin=%5Bobject%20Object%5D&amp;name=unit-test-jest-scquencer.png&amp;originHeight=1603&amp;originWidth=2726&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=292495&amp;status=done&amp;style=none&amp;taskId=udcf49166-d29d-4ba5-97b4-f942d8b9fe4&amp;title=&amp;width=1363" alt="unit-test-jest-scquencer.png"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>		<span class="token keyword">return</span> tests<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">testA<span class="token punctuation">,</span> testB</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>failedA <span class="token operator">!==</span> failedB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> failedA <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hasTimeA <span class="token operator">!=</span> <span class="token punctuation">(</span>testB<span class="token punctuation">.</span>duration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If only one of two tests has timing information, run it last</span>
        <span class="token keyword">return</span> hasTimeA <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>testA<span class="token punctuation">.</span>duration <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> testB<span class="token punctuation">.</span>duration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> testA<span class="token punctuation">.</span>duration <span class="token operator">&lt;</span> testB<span class="token punctuation">.</span>duration <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fileSize</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">fileSize</span><span class="token punctuation">(</span>testB<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>第四步 开始执行</strong>
在经过第三步之后，我们拿到了经过排序后的单测文件，接下来开始进入到执行步骤，执行单测时的整个调度工作是 jest/core 中的 TestScheduler 来完成，例如 scheduler 会推算是串行执行还是并行执行，推算单测执行完的大概时间，覆盖率报告的生成等，scheduler 会调用 jest-runner 中的 runTests 方法去触发单测执行</p> <p>如果需要并行执行，runTest 方法触发 jest-worker 创建多个child process 子进程来支持 parallel 执行</p> <p>单元测试中全局方法和全局变量，比如 test() describe() it() 等是由 jest-cirucs(jest-jasmine) 提供并注入global中</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/116604/1640527878045-b379169e-e180-4226-884d-2da6b90321ec.png#clientId=u059512e6-4582-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;id=u4114c79f&amp;margin=%5Bobject%20Object%5D&amp;name=unit-test-jest-run-test.png&amp;originHeight=2878&amp;originWidth=3480&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=683293&amp;status=done&amp;style=none&amp;taskId=ue36536e2-f975-4782-8f78-6d5203e2ae6&amp;title=" alt="unit-test-jest-run-test.png">
最终单测的运行是由 jest-runtime 中创建的 vm 虚拟机隔离执行，vm 作用域中dom环境是由 jest-environment-jsdom 提供，此外 jest-runtime 中还包括了 transformer 能力以及mock功能的具体实现等，这部分功能在接下来的Mpx框架单元测试实现章节我们会去详细介绍它。</p> <p><strong>第五步 处理返回结果</strong>
此外 jest-runner中提供了一套类似于 redux 的数据流机制和eventEmitter来管理维护单测状态以及单测执行结果，在jest-runner 中进行事件触发，在TestScheduler 中进行事件监听并对执行结果进行各种处理和序列化，
最后在 jest-core 中的runJest方法中进行执行结果的终端输出/文件输出等一系列处理。</p> <h2 id="小程序单元测试"><a href="#小程序单元测试" class="header-anchor">#</a> 小程序单元测试</h2> <h3 id="与-web-应用的不同"><a href="#与-web-应用的不同" class="header-anchor">#</a> 与 web 应用的不同</h3> <p>上个章节讲完前端单测简介，以及jest单测框架的大概运行原理后，接下来我们看下单元测试在小程序场景下与web场景的不同</p> <p>首先小程序本身是双线程分离的机制，但目前并没有这种独特的运行环境用来执行单元测试，这里需要借助小程序官方提供的 miniprogram-simulate 工具集，来将整体运行机制调整为单线程模拟运行，并利用 dom 环境来进行小程序组件的注册渲染以及整个自定义组件树的搭建</p> <p>小程序的单元测试执行依赖 js 运行环境和 dom 环境，这里我们选择 jest 框架来提供对应的环境</p> <p>下方是一个简单的微信小程序官方提供的单元测试demo，具体关于miniprogram-simulate 的更多API的使用可以去官方文档查看 <a href="https://github.com/wechat-miniprogram/miniprogram-simulate" target="_blank" rel="noopener noreferrer">https://github.com/wechat-miniprogram/miniprogram-simulate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> simulate <span class="token keyword">from</span> <span class="token string">'miniprogram-simulate'</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'comp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> simulate<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./comp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 注册自定义组件，返回组件 id</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> simulate<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token comment">// 使用 id 渲染自定义组件，返回组件封装实例</span>

    <span class="token keyword">const</span> parent <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'parent-wrapper'</span><span class="token punctuation">)</span> <span class="token comment">// 创建容器节点</span>
    comp<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token comment">// 将组件插入到容器节点中，会触发 attached 生命周期</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'&lt;div&gt;123&lt;/div&gt;'</span><span class="token punctuation">)</span> <span class="token comment">// 判断组件渲染结果</span>
    <span class="token comment">// 执行其他的一些测试逻辑</span>

    comp<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将组件从容器节点中移除，会触发 detached 生命周期</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>此外对于小程序工具集的整体运行流程，在下方章节进行了简要总结。</p> <h3 id="小程序单测框架整体流程"><a href="#小程序单测框架整体流程" class="header-anchor">#</a> 小程序单测框架整体流程</h3> <p>小程序单元测试中微信官方提供的相关库有 miniprogram-simulate、j-component 和 miniprogram-exparser等</p> <ul><li>miniprogram-simulate: 小程序自定义组件测试工具集，进行小程序内置组件的注册以及模拟微信原生api的注入</li> <li>j-component: 仿小程序组件系统，可以让小程序自定义组件跑在 web 端。</li> <li>miniprogram-exparser：微信小程序官方的组件系统模块，exparser 的组件模型和 WebComponents标准中的 Shadow DOM 高度相似，基于 Shadow DOM 原型，可在纯 JS 环境运行，维护整个组件的节点树相关的信息，包括属性、事件等。</li> <li>miniprogram-compiler:  wcc、wcsc 官方编译器的 node 封装版，用于编译 wxml、wxss 文件</li></ul> <p>开发者在使用的时候经常用的的两个方法就是 simulate.load 和 simulate.render 方法，那这里我们就从这两个方法为入口进行整个流程的总结
<strong>1.miniprogramSimulate.load(path)</strong> <img src="https://cdn.nlark.com/yuque/0/2022/png/116604/1645371259515-600e82a3-5a16-4b50-90d2-4de16b3a6e13.png#clientId=u8f88ae50-6693-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=2179&amp;id=u91907731&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%B0%8F%E7%A8%8B%E5%BA%8F-load.png&amp;originHeight=2179&amp;originWidth=3100&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=655139&amp;status=done&amp;style=none&amp;taskId=uffad3560-8564-4372-bf2f-ceded0ad196&amp;title=&amp;width=3100" alt="小程序-load.png"></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> nowLoad
<span class="token comment">// miniprogram-simulate</span>
<span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> definition</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 省略部分判断</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">register</span><span class="token punctuation">(</span>componentPath<span class="token punctuation">,</span> tagName<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> hasRegisterCache<span class="token punctuation">)</span>
  cache<span class="token punctuation">.</span>needRunJsList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// nowLoad 用于执行用户代码调用 Component 构造器时注入额外的参数给 j-component</span>
    nowLoad <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment">// require('xxx.js')</span>
    _<span class="token punctuation">.</span><span class="token function">runJs</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> id
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter">componentPath<span class="token punctuation">,</span> tagName<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> hasRegisterCache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 随机生成，不重复</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> componentPath<span class="token punctuation">,</span>
    tagName<span class="token punctuation">,</span>
    <span class="token literal-property property">json</span><span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">readJson</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   	<span class="token literal-property property">wxml</span><span class="token operator">:</span> compile<span class="token punctuation">.</span><span class="token function">getWxml</span><span class="token punctuation">(</span>componentPath<span class="token punctuation">,</span> cache<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">wxss</span><span class="token operator">:</span> wxss<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.wxss</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 存入需要执行的自定义组件 js</span>
  cache<span class="token punctuation">.</span>needRunJsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>componentPath<span class="token punctuation">,</span> component<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> component<span class="token punctuation">.</span>id
<span class="token punctuation">}</span>
global<span class="token punctuation">.</span><span class="token function-variable function">Component</span> <span class="token operator">=</span> <span class="token parameter">options</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> component <span class="token operator">=</span> nowLoad
  jComponent<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter">definition <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> componentManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentManager</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>
    <span class="token keyword">return</span> componentManager<span class="token punctuation">.</span>id
<span class="token punctuation">}</span>

<span class="token comment">// ComponentManager 方法</span>
<span class="token keyword">class</span> <span class="token class-name">ComponentManager</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">definition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ......</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exparserDef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerToExparser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        _<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">registerToExparser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
        <span class="token keyword">const</span> exparserDef <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">is</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            using<span class="token punctuation">,</span>
            <span class="token literal-property property">generics</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// TODO</span>
            <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">func</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>generateFunc<span class="token punctuation">,</span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">properties</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>properties<span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
            <span class="token literal-property property">methods</span><span class="token operator">:</span> definition<span class="token punctuation">.</span>methods<span class="token punctuation">,</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// miniprogram-exparser</span>
        <span class="token keyword">return</span> exparser<span class="token punctuation">.</span><span class="token function">registerElement</span><span class="token punctuation">(</span>exparserDef<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>2.miniprogramSimulate.render(id)</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/116604/1645372791716-b3faf038-ff6f-4309-9a91-270bcfda4aa7.png#clientId=u8f88ae50-6693-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=2069&amp;id=u272fdda2&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-render.png&amp;originHeight=2069&amp;originWidth=3131&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=668246&amp;status=done&amp;style=none&amp;taskId=u0ed961d2-5859-4c1b-ac1b-79595d39e8e&amp;title=&amp;width=3131" alt="微信小程序-render.png">
miniprogram-simulate中render方法会调用j-component create，根据id从缓存对象中获取componentManager，进行组件实例创建</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">/**
   * 创建组件实例
   */</span>
  <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> properties</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> componentManager <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentManager<span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RootComponent</span><span class="token punctuation">(</span>componentManager<span class="token punctuation">,</span> properties<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>RootComponent 构造函数中使用之前的 _exparserDef 对象进行真实dom节点创建，生成 _exparserNode</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">RootComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">componentManager<span class="token punctuation">,</span> properties</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_exparserNode <span class="token operator">=</span> exparser<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tagName <span class="token operator">||</span> id<span class="token punctuation">,</span> exparserDef<span class="token punctuation">)</span> <span class="token comment">// create exparser node and render</span>
		<span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// touchstart，touchemove blur 等事件绑定</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>新生成的 rootComponent 实例继承Component对象，定义了许多我们单测中需要用到的组件方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
	<span class="token keyword">get</span> <span class="token function">dom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">...</span>
  <span class="token keyword">get</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token keyword">get</span> instance <span class="token operator">...</span>
  dispatchEvent <span class="token operator">...</span>
  addEventListener <span class="token operator">...</span>
  removeEventListener <span class="token operator">...</span>
  querySelector <span class="token operator">...</span>
  setData <span class="token operator">...</span>
  triggerLifeTime <span class="token operator">...</span>
  triggerPageLifeTime <span class="token operator">...</span>
  toJSON<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然中间还有很多细节实现，比如模版渲染 j-component/template/compile，组件更新 j-component/render 等，感兴趣的话可以详细去看下里边具体的实现，这里我们暂且按下不表。至此，我们拿到了 component 实例，并可以进行正常的组件状态获取以及更新，然后在Jest框架中去断言组件的各种属性以及方法执行后的预期。</p> <h2 id="mpx-框架单元测试"><a href="#mpx-框架单元测试" class="header-anchor">#</a> Mpx 框架单元测试</h2> <p>经过上方 Jest 框架讲解以及小程序单元测试流程分析后，接下来看下在Mpx框架中的单测能力支持实现</p> <h3 id="初期版本"><a href="#初期版本" class="header-anchor">#</a> 初期版本</h3> <p>Mpx框架的初期单测架构，是将Mpx框架开发的小程序项目，先构建编译为源码，再使用 miniprogram-simulate + j-component + jest 对构建后的小程序原生代码运行单元测试
<img src="https://cdn.nlark.com/yuque/0/2021/png/116604/1640786157277-5f92065d-c87e-46ed-b57e-4692b3d78a36.png#clientId=uc72cd25a-bebe-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=485&amp;id=uf9a7caa5&amp;margin=%5Bobject%20Object%5D&amp;name=mpx-old-unit-test-architecture.png&amp;originHeight=969&amp;originWidth=3076&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=744497&amp;status=done&amp;style=none&amp;taskId=uf25026f4-fd27-4116-bcb5-ffbe7357910&amp;title=&amp;width=1538" alt="mpx-old-unit-test-architecture.png">
该方案执行任何case都需要执行完整的构建流程，而且预构建已经完成了所有的模块收集，无法使用jest提供的模块mock功能，导致业务使用成本很高，落地困难。</p> <h3 id="优化版本"><a href="#优化版本" class="header-anchor">#</a> 优化版本</h3> <p>经过调研，Jest 本身支持代码转换功能</p> <blockquote><p>Jest在项目中以JavaScript的代码形式运行，但是如果使用一些Node.js不支持的，却可以开箱即用的语法(如JSX，TypeScript中的类型，Vue模板等)那你就需要将代码转换为纯JavaScript，转换的工作就是transformer</p></blockquote> <p>这里我们就可以通过Jest提供的转换能力编写mpx-jest转换器，实现在Jest模块加载过程中实时地将当前的Mpx组件编译转换为原生小程序组件，再交由miniprogram-simulate加载运行测试case。</p> <p>该方案中模块加载完全基于Jest并能实现按需编译，完美规避旧方案中存在的缺陷，缺点在于编译构建流程基于Jest api重构，与Mpx自身基于Webpack的构建流程独立存在，带来额外维护成本，这一问题我们通过将通用的编译转换逻辑抽离出来统一维护，在Webpack和Jest两侧复用，从而解决了改问题。同时在实现这个方案的过程中也做了一部分对应库的改动，将会在下方介绍。</p> <p>首先来看下 jest-runtime 中 transform 的整体流程。</p> <ul><li>runTest 方法调用 runtime.requireModule(path)，传入对应的单测文件地址</li> <li>判断是否是mock module，如果是则直接走 requireMock方法，否则继续往下进行</li> <li>定义 localModule</li> <li>调用 this._loadModule</li> <li>_createRequireImplementation(module, options) 赋值给module.require</li> <li>transformFile 处理对应的文件</li> <li>createScriptFromCode(transformdCode)</li> <li>getVmContext  使用 vm 创建沙盒环境</li> <li>在沙盒环境执行对应的 jest 单测代码</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/116604/1645251815753-ba8529bb-c63f-477f-bb2a-60182bf5f390.png#clientId=u3600a0a4-27fc-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=811&amp;id=u9a266c8b&amp;margin=%5Bobject%20Object%5D&amp;name=jest-runtime1.png&amp;originHeight=3242&amp;originWidth=4075&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=1246325&amp;status=done&amp;style=none&amp;taskId=uae1603dd-c05f-443b-977e-849426edf0d&amp;title=&amp;width=1019" alt="jest-runtime1.png">
其中关键节点的代码如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>			<span class="token comment">// 自定义 localModule</span>
			<span class="token keyword">const</span> localModule <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> modulePath<span class="token punctuation">,</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> modulePath<span class="token punctuation">,</span>
        <span class="token literal-property property">loaded</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// 自定义 module.require</span>
			Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">'require'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// rquireModuleOrMock || rquireInternalModule</span>
      	<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createRequireImplementation</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// transformCode</span>
			<span class="token keyword">const</span> transformedCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transformFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// createScriptFromCode</span>
			<span class="token keyword">const</span> script <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">script</span><span class="token punctuation">(</span><span class="token string">'({&quot;'</span> <span class="token operator">+</span> <span class="token constant">EVAL_RESULT_VARIABLE</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;:function(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">){</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> transformedCode <span class="token operator">+</span> <span class="token string">'\n}});'</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
			<span class="token keyword">const</span> vmContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_environment<span class="token punctuation">.</span><span class="token function">getVmContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      runScript <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>vmContext<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        filename
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
			compiledFunction <span class="token operator">=</span> runScript<span class="token punctuation">[</span><span class="token constant">EVAL_RESULT_VARIABLE</span><span class="token punctuation">]</span>
      <span class="token function">compiledFunction</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
        module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
        module<span class="token punctuation">,</span> <span class="token comment">// module object</span>
        module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token comment">// module exports</span>
        module<span class="token punctuation">.</span>require<span class="token punctuation">,</span> <span class="token comment">// require implementation</span>
        module<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token comment">// __dirname</span>
        module<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> <span class="token comment">// __filename</span>
        <span class="token comment">// @ts-expect-error</span>
        <span class="token operator">...</span>lastArgs<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>notEmpty<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上方是整个 jest-runtime 中对于require module 时transform的整体流程。在Jest的这一能力之上，我们基于 @mpxjs/webpack-plugin 开发了 mpx-jest transformer，实现将 Mpx 单文件组件转换输出为对应的小程序原生代码。
<img src="https://cdn.nlark.com/yuque/0/2022/png/116604/1645264785364-2db4095b-0344-4fa8-8d56-bfeb28c0f78d.png#clientId=uec723a90-39b3-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=1588&amp;id=ubbef4532&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%94%B9%E8%89%AF%E6%96%B9%E6%A1%8801.png&amp;originHeight=1588&amp;originWidth=3007&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=368757&amp;status=done&amp;style=none&amp;taskId=u8c2c10f8-f83f-4765-b312-bb75081e05c&amp;title=&amp;width=3007" alt="改良方案01.png">
在完成代码转换后，对应的 script 代码做为String存在于内存中，无法直接使用 Jest 环境的 require 加载执行，为此我们参考上述 jest-runtime 中的 loadModule方法实现了requireFromString方法，核心还是使用node vm 模块来进行 script 代码的执行，同时将jsdom-environment 和 Jest global 对象合并做为 vmContext</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/116604/1645269513406-df59853a-086d-4d5f-87a5-cb003d556ce9.png#clientId=uec723a90-39b3-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=802&amp;id=u2da3911b&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%94%B9%E9%80%A0%E6%96%B9%E6%A1%882.png&amp;originHeight=802&amp;originWidth=1970&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=125179&amp;status=done&amp;style=none&amp;taskId=u182d9b94-f659-4d25-80d5-d9d01fdbaac&amp;title=&amp;width=1970" alt="改造方案2.png">
至此，我们的整体单测方案就大致完成，通过 mpx-jest 转换组件，再交由 miniprogram-simulate 来渲染组件实例，从而完成对组件状态的断言，在实际测试的过程中，还遇到了以下问题进行解决。</p> <p>1.Mpx框架的文件纬度的条件编译支持
Mpx框架的跨平台输出部分支持对文件进行平台和应用的条件编译引用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 文件列表</span>
example<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>mpx
example<span class="token punctuation">.</span>ali<span class="token punctuation">.</span>mpx

<span class="token comment">// 代码使用</span>
<span class="token punctuation">{</span>
	<span class="token literal-property property">example</span><span class="token operator">:</span> <span class="token string">'../src/example'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们需要在Jest运行时环境中提供该功能，借助Jest本身提供的 resolver 自定义能力，让我们可以对请求的文件进行自定义resolve功能，这里我们使用Mpx中现有的resolve plugin 和 enhanced-resolve来自定义resolve方法进行文件条件编译的支持。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> CachedInputFileSystem<span class="token punctuation">,</span> ResolverFactory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'enhanced-resolve'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> AddModePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@mpxjs/webpack-plugin/lib/resolver/AddModePlugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> addModePlugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddModePlugin</span><span class="token punctuation">(</span><span class="token string">'before-file'</span><span class="token punctuation">,</span> <span class="token string">'wx'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">include</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'file'</span><span class="token punctuation">)</span>
  <span class="token comment">// create a resolver</span>
  <span class="token keyword">const</span> myResolver <span class="token operator">=</span> ResolverFactory<span class="token punctuation">.</span><span class="token function">createResolver</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>addModePlugin<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> myResolver<span class="token punctuation">.</span><span class="token function">resolveSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>basedir<span class="token punctuation">,</span> request<span class="token punctuation">)</span>
	<span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2.miniprogram-simulate 定制化方法
在小程序单元测试的章节中，我们介绍了小程序相关库的运行机制，miniprogram-simulate提供的 load 方法默认只解析渲染原生组件，我们的Mpx组件，mpx-jest 转换器无法和miniprogram-simulate进行关联，所以这里我们选择fork miniprogram-simulate 仓库，自定义了loadMpx和registerMpx方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 使用</span>
<span class="token keyword">import</span> simulate <span class="token keyword">from</span> <span class="token string">'@mpxjs/miniprogram-simulate'</span>
<span class="token keyword">const</span> id <span class="token operator">=</span> simulate<span class="token punctuation">.</span><span class="token function">loadMpx</span><span class="token punctuation">(</span><span class="token string">'src/components/list.mpx'</span><span class="token punctuation">)</span>

<span class="token comment">//@mpxjs/miniprogram-simulate 中 loadMpx 实现简单描述</span>
<span class="token keyword">function</span> <span class="token function">loadMpx</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> tagName<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...省略一部分校验逻辑</span>
  <span class="token comment">// .mpx 结尾文件会经过 mpx-jest 进行转换，输出 wxml,wxss,json,script</span>
  <span class="token keyword">const</span> componentContent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>componentPath<span class="token punctuation">)</span>
  id <span class="token operator">=</span> <span class="token function">registerMpx</span><span class="token punctuation">(</span>componentPath<span class="token punctuation">,</span> tagName<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> hasRegisterCache<span class="token punctuation">,</span> componentContent<span class="token punctuation">)</span>
  <span class="token comment">//....</span>
  <span class="token keyword">return</span> id
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">registerMpx</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 部分 require('xx/xx.json') 等修改为直接赋值</span>
<span class="token punctuation">}</span>

</code></pre></div><p>对于组件/页面在存在大量组件引用的情况下，mock引用组件可大大提升单测的运行速度，原有miniprogram-simulate框架并没有提供mock功能，所以这里我们也自定义了mockComponent和clearMockComponent方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 代码在 @mpxjs/miniprogram-simulate 中</span>
<span class="token keyword">let</span> mockComponentMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">registerMpx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 判断是否是mock的组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mockComponentMap<span class="token punctuation">[</span>tagName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentPath <span class="token operator">=</span> mockComponentMap<span class="token punctuation">[</span>tagName<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * mock usingComponents中的组件
 * @param compName
 * @param compDefinition
 */</span>
<span class="token keyword">function</span> <span class="token function">mockComponent</span><span class="token punctuation">(</span><span class="token parameter">compName<span class="token punctuation">,</span> compDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mockComponentMap<span class="token punctuation">[</span>compName<span class="token punctuation">]</span> <span class="token operator">=</span> compDefinition
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 清除 component mock 数据
 */</span>
<span class="token keyword">function</span> <span class="token function">clearMockComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mockComponentMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 单测中使用时</span>
simulate<span class="token punctuation">.</span><span class="token function">mockComponent</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'&lt;view&gt;component list&lt;/view&gt;'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>3.封装定制test-utils工具集
书写单测的过程中我们会有很多重复工作，比如创建挂载组件、代理接口、模拟多个组件、断言多个数据等，这里我们将这些共性的方法抽离封装成了 test-utils</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * 创建渲染并挂载自定义组件
 * @param {组件基于所在项目的相对路径,例如'src/subpackage/gulfstream/components/bottom/bottom.mpx'} compPath
 * @returns 用于测试的自定义组件
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createCompAndAttach</span> <span class="token punctuation">(</span><span class="token parameter">compPath<span class="token punctuation">,</span> renderProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> simulate<span class="token punctuation">.</span><span class="token function">loadMpx</span><span class="token punctuation">(</span>compPath<span class="token punctuation">)</span>
  <span class="token keyword">let</span> comp <span class="token operator">=</span> simulate<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> renderProps<span class="token punctuation">)</span>
  <span class="token keyword">const</span> parent <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
  comp<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
  <span class="token keyword">return</span> comp
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 借助xfetch构造mock请求
 * @param {待模拟url} mockUrl
 * @param {mock数据文件路径} mockFilePath
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxyFetch</span> <span class="token punctuation">(</span><span class="token parameter">mockUrl<span class="token punctuation">,</span> mockUrlData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> mockData
  mpx<span class="token punctuation">.</span>xfetch<span class="token punctuation">.</span>fetch <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>mockUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> mockUrlData <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mockData <span class="token operator">=</span> <span class="token function">getMockContent</span><span class="token punctuation">(</span>mockUrlData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          mockData <span class="token operator">=</span> mockUrlData
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">errno</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> mockData
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span><span class="token operator">...</span>
</code></pre></div><p>至此，Mpx框架的单元测试方案整体上就完备了，整体上的方案架构如下图所示
<img src="https://cdn.nlark.com/yuque/0/2022/png/116604/1645448762294-8e4cb0ab-bc09-4688-9360-ab4d67776af1.png#clientId=uc67aedb9-b0af-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=1164&amp;id=u19264b9b&amp;margin=%5Bobject%20Object%5D&amp;name=Mpx%E5%8D%95%E6%B5%8B%E6%9E%B6%E6%9E%84%E5%9B%BE.png&amp;originHeight=2327&amp;originWidth=3335&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=7199152&amp;status=done&amp;style=none&amp;taskId=uc2ecd51a-8419-46f1-a52a-1c9a8868ce1&amp;title=&amp;width=1667.5" alt="Mpx单测架构图.png"></p> <h2 id="mpx组件单元测试实战"><a href="#mpx组件单元测试实战" class="header-anchor">#</a> Mpx组件单元测试实战</h2> <p>在上方介绍过整体的jest框架流程以及Mpx框架单元测试架构后，接下来我们着手进行 Mpx 框架开发的小程序组件的单元测试用例书写实战</p> <p>使用 @mpxjs/cli 创建模版项目时选择使用单元测试，<strong>会自动生成有单测能力的模版项目</strong>，和普通 Jest + miniprogram-simulate 搭建的原生小程序单测项目不同的是，transform 中添加了 Mpx 文件的处理，这里jest.config.js其他配置就不过多列出，可通过新创建项目进行查看。</p> <div class="language-json extra-class"><pre class="language-json"><code>	transform<span class="token operator">:</span> <span class="token punctuation">{</span>
    '^.+\\.js$'<span class="token operator">:</span> '&lt;rootDir&gt;/node_modules/babel-jest'<span class="token punctuation">,</span>
    '^.+\\.mpx$'<span class="token operator">:</span> '&lt;rootDir&gt;/node_modules/@mpxjs/mpx-jest'
  <span class="token punctuation">}</span>
</code></pre></div><p>首先我们列出一个组件示例，具体项目可点击链接查看:
<a href="https://github.com/Blackgan3/mpx-unit-test-demo" target="_blank" rel="noopener noreferrer">https://github.com/Blackgan3/mpx-unit-test-demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>首先对于组件单测的书写，我们希望有一套固定的规范，即所写的不同组件的单测能有一个相同的格式和顺序，这里我们建议的顺序为</p> <ul><li>组件初始化断言</li> <li>组件初始化各种形态断言</li> <li>组件变化- data|computed|watch变化断言</li> <li>组件变化- 事件触发断言</li> <li>组件销毁断言</li></ul> <p>根据上方组件功能，首先我们建议对组件usingComponents 引入的组件进行模拟注册，这样可以节省组件渲染挂载的时间</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>	<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进行usingComponents 组件 mock</span>
    testUtils<span class="token punctuation">.</span><span class="token function">mockComponents</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token string">'list'</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>1.我们首先需要对组件初始化成功后进行各种组件形态预期，即组件初始化断言</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>	<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test component init correctly'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> testUtils<span class="token punctuation">.</span><span class="token function">createCompAndAttach</span><span class="token punctuation">(</span>compPath<span class="token punctuation">)</span>
    <span class="token keyword">const</span> insData <span class="token operator">=</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data
    testUtils<span class="token punctuation">.</span><span class="token function">checkExpectedData</span><span class="token punctuation">(</span>insData<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">someClassShowOne</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">someClassShowTwo</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">someClassShowTwoFlag</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">listData2</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;手机&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;电视&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;电脑&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">compStatus</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">timeDeferFlag</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> domHTML <span class="token operator">=</span> comp<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML
    <span class="token comment">// 进行组件初始化dom快照测试</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>domHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上方我们使用工具方法创建并挂载生成组件实例，然后对组件data中key值和value进行预期断言，最后对组件初始化生成的HTML进行快照测试</p> <p>2.组件初始化各种形态断言
当组件的初始化数据源有多种形态，比如你的组件初始化数据是由接口或者其他重要的props传递过来决定的，那这里我们可以对不同的数据源组件的不同表现进行断言</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>	<span class="token function">it</span> <span class="token punctuation">(</span><span class="token string">'test comp different data'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进行唯一数据源请求的接口代理</span>
    <span class="token function">proxyFetch</span><span class="token punctuation">(</span><span class="token string">'api/somePackage/getCompData'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> testUtils<span class="token punctuation">.</span><span class="token function">createCompAndAttach</span><span class="token punctuation">(</span>compPath<span class="token punctuation">)</span>
    <span class="token comment">// 目前 status 为 1，再次改变数据源代理</span>
    <span class="token function">proxyFetch</span><span class="token punctuation">(</span><span class="token string">'api/somePackage/getCompData'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">fetchCompData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data<span class="token punctuation">.</span>compStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data<span class="token punctuation">.</span>compData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 再次改变数据源代理，修改源数据</span>
    <span class="token function">proxyFetch</span><span class="token punctuation">(</span><span class="token string">'api/somePackage/getCompData'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">fetchCompData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data<span class="token punctuation">.</span>compStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data<span class="token punctuation">.</span>compData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>3.组件变化- props|data|computed|watch变化断言
接下来我们需要对组件自身的 props|data|computed|watch 等属性变化时所触发的组件相应变化做出各种预期。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>	<span class="token comment">// 组件 props 改变后组件的各种形态预期</span>
	<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test props different values correspond to different performance'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传入初始渲染 props</span>
    <span class="token keyword">const</span> successContent <span class="token operator">=</span> <span class="token string">'some successContent'</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> testUtils<span class="token punctuation">.</span><span class="token function">createCompAndAttach</span><span class="token punctuation">(</span>compPath<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      successContent
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> childComp <span class="token operator">=</span> comp<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.successContent'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>childComp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data<span class="token punctuation">.</span>successContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>successContent<span class="token punctuation">)</span>
    <span class="token comment">// 对最终的HTML进行快照测试</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>childComp<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 当组件data中的someClassShowOne改变之后需要做的哪些预期</span>
	<span class="token comment">// 当组件computed中的someCompShow改变之后需要做的预期</span>
	<span class="token comment">// ......</span>
	
</code></pre></div><p>4.组件必不可少的会有方法，这里我们对示例组件的方法调用进行预期</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>	<span class="token function">it</span> <span class="token punctuation">(</span><span class="token string">'test someClassShowTwoFlag tap event trigger'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> testUtils<span class="token punctuation">.</span><span class="token function">createComp</span><span class="token punctuation">(</span>compPath<span class="token punctuation">)</span>
    <span class="token keyword">const</span> fetchCompDataSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token string">'fetchCompData'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> changeSomeClassShowTwoFlagSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token string">'changeSomeClassShowTwoFlag'</span><span class="token punctuation">)</span>
    <span class="token function">proxyFetch</span><span class="token punctuation">(</span><span class="token string">'api/somePackage/getCompData'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    comp<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token keyword">const</span> compData <span class="token operator">=</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data
    <span class="token keyword">const</span> changeFlagViewComp <span class="token operator">=</span> comp<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.changeFlagClass'</span><span class="token punctuation">)</span>

    <span class="token comment">// dispatchEvent 为异步</span>
    changeFlagViewComp<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token string">'tap'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> testUtils<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>changeSomeClassShowTwoFlagSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalledWith</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>fetchCompDataSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>compData<span class="token punctuation">.</span>someClassShowTwo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>someClassShowTwoFlag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 此处注意 非template中使用过到的data，获取更新后的值，从instance中获取</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>	

	<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'test someTimeDeferAction tap event trigger'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>global<span class="token punctuation">,</span> <span class="token string">'setTimeout'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> comp <span class="token operator">=</span> testUtils<span class="token punctuation">.</span><span class="token function">createCompAndAttach</span><span class="token punctuation">(</span>compPath<span class="token punctuation">)</span>
    <span class="token keyword">const</span> compData <span class="token operator">=</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data
    <span class="token keyword">const</span> someTimeDeferActionSpy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token string">'someTimeDeferAction'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> childComp <span class="token operator">=</span> comp<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.someTimeDeferActionClass'</span><span class="token punctuation">)</span>
    childComp<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token string">'tap'</span><span class="token punctuation">)</span>

    <span class="token comment">// comp.instance.someTimeDeferAction()</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    jest<span class="token punctuation">.</span><span class="token function">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>compData<span class="token punctuation">.</span>timeDeferFlag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>someTimeDeferActionSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    jest<span class="token punctuation">.</span><span class="token function">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以上，我们对当前的示例组件完成了整体内容的单元测试书写，完整版单测文件可点击链接查看
<a href="https://github.com/Blackgan3/mpx-unit-test-demo/blob/master/test/components/example.spec.js" target="_blank" rel="noopener noreferrer">https://github.com/Blackgan3/mpx-unit-test-demo/blob/master/test/components/example.spec.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>通篇文章我们依次进行了前端常用单测框架简介，jest框架原理总结，小程序单元测试内部执行流程，最后介绍Mpx框架中单测能力的支持实现以及Mpx组件单测实战。</p> <p>学习到了jest不仅仅是一个单元测试框架，你甚至可以使用它的各个工具库自己创建一个单元测试框架；以及感受到小程序场景下单元测试的差异化；Mpx框架层面也做了诸多改造来支撑单测功能的落地。</p> <p>后续我们还会继续跟进推动业务中落地TDD规范，复杂逻辑组件中各种功能场景单测用例规范的补充等问题，持续在小程序单测方向深耕并有更好的规范总结产出。</p> <p>参考文章：</p> <ul><li><a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">https://jestjs.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://jestjs.io/docs/architecture" target="_blank" rel="noopener noreferrer">https://jestjs.io/docs/architecture<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://medium.com/code-for-cause/jest-architecture-9870bbfcda44" target="_blank" rel="noopener noreferrer">https://medium.com/code-for-cause/jest-architecture-9870bbfcda44<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/mpx-cli-next.html" class="prev">
        Mpx-cli 插件化改造
      </a></span> <!----></p></div> </main></div></div></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.84c88b57.js" defer></script><script src="/assets/js/7.01e4e942.js" defer></script><script src="/assets/js/3.145e69cd.js" defer></script><script src="/assets/js/1.4f7abe8f.js" defer></script><script src="/assets/js/62.4bf212f9.js" defer></script><script src="/assets/js/30.04d1a7ea.js" defer></script>
  </body>
</html>
